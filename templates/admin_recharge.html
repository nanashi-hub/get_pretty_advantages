{% extends "base.html" %}

{% block title %}å……å€¼ç®¡ç† - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}å……å€¼ç®¡ç†{% endblock %}

{% block content %}
<div class="page-actions">
    <div class="action-group">
        <button class="btn btn-primary" onclick="AdminRecharge.showCreateModal()">
            <span class="icon">â•</span> åˆ›å»ºå……å€¼è®¢å•
        </button>
        <button class="btn btn-secondary" onclick="AdminRecharge.checkAllPayments()">
            <span class="icon">ğŸ”„</span> æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        </button>
        <button class="btn btn-secondary" onclick="AdminRecharge.loadOrders()">
            <span class="icon">ğŸ”ƒ</span> åˆ·æ–°
        </button>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-label">å¾…æ”¯ä»˜</div>
        <div class="stat-value" id="pendingCount">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å·²æ”¯ä»˜</div>
        <div class="stat-value" id="paidCount">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å·²å®Œæˆ</div>
        <div class="stat-value" id="confirmedCount">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥é‡‘é¢</div>
        <div class="stat-value" id="todayAmount">-</div>
    </div>
</div>

<!-- ç­›é€‰æ  -->
<div class="filter-bar">
    <div class="filter-group">
        <label>çŠ¶æ€:</label>
        <select id="statusFilter">
            <option value="">å…¨éƒ¨</option>
            <option value="pending">å¾…æ”¯ä»˜</option>
            <option value="paid">å·²æ”¯ä»˜</option>
            <option value="confirmed">å·²å®Œæˆ</option>
            <option value="expired">å·²è¿‡æœŸ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
    </div>
    <div class="filter-group">
        <label>ç”¨æˆ·ID:</label>
        <input type="number" id="userIdFilter" placeholder="ç”¨æˆ·ID" style="width:100px;">
    </div>
    <div class="filter-group">
        <button class="btn btn-secondary" onclick="AdminRecharge.applyFilters()">ç­›é€‰</button>
        <button class="btn btn-secondary" onclick="AdminRecharge.resetFilters()">é‡ç½®</button>
    </div>
</div>

<!-- è®¢å•åˆ—è¡¨ -->
<div class="data-card">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="50">ID</th>
                    <th width="140">è®¢å•å·</th>
                    <th width="80">ç”¨æˆ·ID</th>
                    <th width="100">é‡‘é¢</th>
                    <th width="100">çŠ¶æ€</th>
                    <th width="140">æ”¯ä»˜å®äº¤æ˜“å·</th>
                    <th width="160">åˆ›å»ºæ—¶é—´</th>
                    <th width="120">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- è½¬è´¦è®°å½•åŒºåŸŸ -->
<div class="section-divider">
    <h3>è½¬è´¦è®°å½•ï¼ˆåˆ†è´¦æ˜ç»†ï¼‰</h3>
</div>

<div class="filter-bar">
    <div class="filter-group">
        <label>çŠ¶æ€:</label>
        <select id="transferStatusFilter">
            <option value="">å…¨éƒ¨</option>
            <option value="pending">å¾…è½¬è´¦</option>
            <option value="processing">è½¬è´¦ä¸­</option>
            <option value="success">æˆåŠŸ</option>
            <option value="failed">å¤±è´¥</option>
        </select>
    </div>
    <div class="filter-group">
        <label>è®¢å•ID:</label>
        <input type="number" id="orderIdFilter" placeholder="è®¢å•ID" style="width:100px;">
    </div>
    <div class="filter-group">
        <button class="btn btn-secondary" onclick="AdminRecharge.loadTransfers()">ç­›é€‰</button>
        <button class="btn btn-secondary" onclick="AdminRecharge.resetTransferFilters()">é‡ç½®</button>
    </div>
</div>

<div class="data-card">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="50">ID</th>
                    <th width="80">è®¢å•ID</th>
                    <th width="80">ç”¨æˆ·ID</th>
                    <th width="80">è§’è‰²</th>
                    <th width="150">æ”¯ä»˜å®è´¦å·</th>
                    <th width="100">é‡‘é¢</th>
                    <th width="100">çŠ¶æ€</th>
                    <th width="100">è½¬è´¦æ—¶é—´</th>
                    <th width="150">å¤±è´¥åŸå› </th>
                </tr>
            </thead>
            <tbody id="transfersTableBody">
                <tr><td colspan="9" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
}

.filter-group input {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-right: 8px;
}

.section-divider {
    margin: 32px 0 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}

.section-divider h3 {
    margin: 0;
    font-size: 16px;
    color: #374151;
}

.role-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.role-platform { background: #e0e7ff; color: #4338ca; }
.role-agent_l1 { background: #fef3c7; color: #92400e; }
.role-agent_l2 { background: #fef9c3; color: #a16207; }
.role-user { background: #dcfce7; color: #166534; }
</style>

<!-- åˆ›å»ºè®¢å•æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="createOrderModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>åˆ›å»ºå……å€¼è®¢å•</h3>
            <button class="modal-close" onclick="AdminRecharge.closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createOrderForm">
                <div class="form-group">
                    <label>ç”¨æˆ·ID <span class="required">*</span></label>
                    <input type="number" id="orderUserId" required
                           placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
                </div>
                <div class="form-group">
                    <label>å……å€¼é‡‘é¢ <span class="required">*</span></label>
                    <input type="number" id="orderAmount" step="0.01" min="0.01" required
                           placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢">
                </div>
                <div class="form-group">
                    <label>ä»˜æ¬¾å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                    <input type="text" id="orderRemark" maxlength="200"
                           placeholder="å¯å¡«å†™å¤‡æ³¨ä¿¡æ¯">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="AdminRecharge.closeCreateModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="AdminRecharge.createOrder()">åˆ›å»º</button>
        </div>
    </div>
</div>

<!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="orderDetailModal" style="display: none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3>è®¢å•è¯¦æƒ…</h3>
            <button class="modal-close" onclick="AdminRecharge.closeDetailModal()">&times;</button>
        </div>
        <div class="modal-body" id="orderDetailContent">
            <!-- åŠ¨æ€å†…å®¹ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="AdminRecharge.closeDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
(function() {
    let allOrders = [];
    let allTransfers = [];

    const STATUS_MAP = {
        'pending': { label: 'å¾…æ”¯ä»˜', class: 'status-pending' },
        'paid': { label: 'å·²æ”¯ä»˜', class: 'status-warning' },
        'confirmed': { label: 'å·²å®Œæˆ', class: 'status-success' },
        'cancelled': { label: 'å·²å–æ¶ˆ', class: 'status-disabled' },
        'expired': { label: 'å·²è¿‡æœŸ', class: 'status-disabled' }
    };

    const TRANSFER_STATUS_MAP = {
        'pending': { label: 'å¾…è½¬è´¦', class: 'status-pending' },
        'processing': { label: 'è½¬è´¦ä¸­', class: 'status-warning' },
        'success': { label: 'æˆåŠŸ', class: 'status-success' },
        'failed': { label: 'å¤±è´¥', class: 'status-error' },
        'refunded': { label: 'å·²é€€å›', class: 'status-disabled' }
    };

    const ROLE_MAP = {
        'platform': 'å¹³å°',
        'agent_l1': 'ä¸€çº§ä»£ç†',
        'agent_l2': 'äºŒçº§ä»£ç†',
        'user': 'å·ä¸»'
    };

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        setTimeout(initPage, 0);
    }

    async function initPage() {
        await Promise.all([
            loadOrders(),
            loadTransfers(),
            updateStats()
        ]);
    }

    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');

        try {
            const statusFilter = document.getElementById('statusFilter').value;
            const userIdFilter = document.getElementById('userIdFilter').value;

            let url = '/recharge/admin/orders?';
            if (statusFilter) url += `status_filter=${statusFilter}&`;
            if (userIdFilter) url += `user_id=${userIdFilter}&`;

            const orders = await apiRequest(url);
            allOrders = orders;
            renderOrders(orders);
            updateStats();
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="8" class="error-cell">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');

        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— è®¢å•</td></tr>';
            return;
        }

        tbody.innerHTML = orders.map(order => {
            const statusInfo = STATUS_MAP[order.status] || { label: order.status, class: '' };
            const canDistribute = order.status === 'paid';
            const canManualConfirm = order.status === 'pending';

            return `
                <tr>
                    <td>${order.id}</td>
                    <td><code style="font-size:12px;">${order.order_no}</code></td>
                    <td>${order.user_id}</td>
                    <td style="font-weight:600;color:#10b981;">Â¥${parseFloat(order.amount).toFixed(2)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></td>
                    <td><code style="font-size:11px;">${order.alipay_trade_no || '-'}</code></td>
                    <td>${formatDateTime(order.created_at)}</td>
                    <td>
                        <div class="btn-group-inline">
                            <button class="btn-action" onclick="AdminRecharge.viewOrderDetail(${order.id}, '${order.order_no}')">è¯¦æƒ…</button>
                            ${canManualConfirm ? `<button class="btn-action btn-action-primary" onclick="AdminRecharge.manualConfirmPayment('${order.order_no}')">ç¡®è®¤æ”¯ä»˜</button>` : ''}
                            ${canDistribute ? `<button class="btn-action" onclick="AdminRecharge.distributeOrder('${order.order_no}')">åˆ†è´¦</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // åŠ è½½è½¬è´¦è®°å½•
    async function loadTransfers() {
        const tbody = document.getElementById('transfersTableBody');

        try {
            const statusFilter = document.getElementById('transferStatusFilter').value;
            const orderIdFilter = document.getElementById('orderIdFilter').value;

            let url = '/recharge/admin/transfers?';
            if (statusFilter) url += `status_filter=${statusFilter}&`;
            if (orderIdFilter) url += `order_id=${orderIdFilter}&`;

            const transfers = await apiRequest(url);
            allTransfers = transfers;
            renderTransfers(transfers);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="9" class="error-cell">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // æ¸²æŸ“è½¬è´¦è®°å½•
    function renderTransfers(transfers) {
        const tbody = document.getElementById('transfersTableBody');

        if (!transfers || transfers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-cell">æš‚æ— è½¬è´¦è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = transfers.map(t => {
            const statusInfo = TRANSFER_STATUS_MAP[t.status] || { label: t.status, class: '' };
            const roleClass = `role-${t.role}`;

            return `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.recharge_order_id}</td>
                    <td>${t.user_id}</td>
                    <td><span class="role-badge ${roleClass}">${ROLE_MAP[t.role] || t.role}</span></td>
                    <td><code style="font-size:11px;">${t.alipay_account || '-'}</code></td>
                    <td style="font-weight:600;color:#10b981;">Â¥${parseFloat(t.amount).toFixed(2)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></td>
                    <td>${formatDateTime(t.transferred_at)}</td>
                    <td style="font-size:12px;color:#ef4444;">${t.fail_reason || '-'}</td>
                </tr>
            `;
        }).join('');
    }

    // æ›´æ–°ç»Ÿè®¡
    async function updateStats() {
        const pending = allOrders.filter(o => o.status === 'pending').length;
        const paid = allOrders.filter(o => o.status === 'paid').length;
        const confirmed = allOrders.filter(o => o.status === 'confirmed').length;

        // è®¡ç®—ä»Šæ—¥é‡‘é¢
        const today = new Date().toDateString();
        const todayAmount = allOrders
            .filter(o => {
                const orderDate = new Date(o.created_at).toDateString();
                return orderDate === today && (o.status === 'paid' || o.status === 'confirmed');
            })
            .reduce((sum, o) => sum + parseFloat(o.amount), 0);

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('paidCount').textContent = paid;
        document.getElementById('confirmedCount').textContent = confirmed;
        document.getElementById('todayAmount').textContent = `Â¥${todayAmount.toFixed(2)}`;
    }

    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        loadOrders();
    }

    // é‡ç½®ç­›é€‰
    function resetFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('userIdFilter').value = '';
        loadOrders();
    }

    // é‡ç½®è½¬è´¦ç­›é€‰
    function resetTransferFilters() {
        document.getElementById('transferStatusFilter').value = '';
        document.getElementById('orderIdFilter').value = '';
        loadTransfers();
    }

    // æ£€æŸ¥æ‰€æœ‰æ”¯ä»˜
    async function checkAllPayments() {
        try {
            showToast('æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...', 'info');
            const result = await apiRequest('/recharge/admin/check-payments', {
                method: 'POST'
            });

            showToast(`æ£€æŸ¥å®Œæˆ: æ£€æŸ¥ ${result.checked_orders} ä¸ªè®¢å•ï¼Œç¡®è®¤ ${result.confirmed_orders} ä¸ª`, 'success');
            await loadOrders();
        } catch (error) {
            showToast('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ‰‹åŠ¨ç¡®è®¤æ”¯ä»˜ï¼ˆç”¨äºä¸ªäººæ”¶æ¬¾ç è½¬è´¦åœºæ™¯ï¼‰
    async function manualConfirmPayment(orderNo) {
        // æç¤ºè¾“å…¥æ”¯ä»˜å®äº¤æ˜“å·
        const alipayTradeNo = prompt(`è¯·è¾“å…¥æ”¯ä»˜å®äº¤æ˜“å·ï¼ˆä»æ”¯ä»˜å®è´¦å•ä¸­å¤åˆ¶ï¼‰\n\nè®¢å•å·: ${orderNo}\n\næç¤ºï¼š\n1. æ‰“å¼€æ”¯ä»˜å®App\n2. è¿›å…¥è´¦å•è¯¦æƒ…\n3. å¤åˆ¶äº¤æ˜“å·å¹¶ç²˜è´´åˆ°æ­¤å¤„`);

        if (!alipayTradeNo || !alipayTradeNo.trim()) {
            return; // ç”¨æˆ·å–æ¶ˆæˆ–æœªè¾“å…¥
        }

        if (!confirm(`ç¡®è®¤è¦æ ‡è®°æ­¤è®¢å•ä¸ºå·²æ”¯ä»˜å—ï¼Ÿ\n\nè®¢å•å·: ${orderNo}\næ”¯ä»˜å®äº¤æ˜“å·: ${alipayTradeNo.trim()}\n\nç¡®è®¤åå°†è‡ªåŠ¨æ‰§è¡Œåˆ†è´¦æ“ä½œ`)) {
            return;
        }

        try {
            showToast('æ­£åœ¨ç¡®è®¤æ”¯ä»˜...', 'info');
            const result = await apiRequest(`/recharge/admin/orders/${orderNo}/manual-confirm`, {
                method: 'POST',
                body: JSON.stringify({ alipay_trade_no: alipayTradeNo.trim() })
            });

            if (result.success) {
                showToast(`æ”¯ä»˜ç¡®è®¤æˆåŠŸï¼å·²åˆ†è´¦ ${result.transfers_count} æ¡è®°å½•`, 'success');
                await loadOrders();
                await loadTransfers();
            } else {
                showToast('æ”¯ä»˜å·²ç¡®è®¤ï¼Œä½†åˆ†è´¦å¤±è´¥: ' + (result.error || result.message), 'warning');
                await loadOrders();
            }
        } catch (error) {
            showToast('ç¡®è®¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ‰‹åŠ¨åˆ†è´¦
    async function distributeOrder(orderNo) {
        if (!confirm(`ç¡®å®šè¦æ‰§è¡Œåˆ†è´¦æ“ä½œå—ï¼Ÿ\nè®¢å•å·: ${orderNo}`)) return;

        try {
            showToast('æ­£åœ¨æ‰§è¡Œåˆ†è´¦...', 'info');
            const result = await apiRequest(`/recharge/admin/orders/${orderNo}/distribute`, {
                method: 'POST'
            });

            showToast(`åˆ†è´¦å®Œæˆï¼Œå…± ${result.transfers_count} æ¡è½¬è´¦è®°å½•`, 'success');
            await loadOrders();
            await loadTransfers();
        } catch (error) {
            showToast('åˆ†è´¦å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºåˆ›å»ºè®¢å•æ¨¡æ€æ¡†
    function showCreateModal() {
        document.getElementById('orderUserId').value = '';
        document.getElementById('orderAmount').value = '';
        document.getElementById('orderRemark').value = '';
        document.getElementById('createOrderModal').style.display = 'flex';
    }

    // å…³é—­åˆ›å»ºè®¢å•æ¨¡æ€æ¡†
    function closeCreateModal() {
        document.getElementById('createOrderModal').style.display = 'none';
    }

    // åˆ›å»ºè®¢å•
    async function createOrder() {
        const userId = parseInt(document.getElementById('orderUserId').value);
        const amount = parseFloat(document.getElementById('orderAmount').value);
        const remarkIn = document.getElementById('orderRemark').value || null;

        if (!userId || !amount || amount <= 0) {
            showToast('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯', 'error');
            return;
        }

        try {
            showToast('æ­£åœ¨åˆ›å»ºè®¢å•...', 'info');

            // éœ€è¦ä¸´æ—¶åˆ‡æ¢ä¸ºè¯¥ç”¨æˆ·æ¥åˆ›å»ºè®¢å•ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥è°ƒç”¨æ¥å£ï¼‰
            // æ³¨æ„ï¼šå½“å‰å®ç°éœ€è¦ç”¨æˆ·æœ¬äººåˆ›å»ºï¼Œæ‰€ä»¥è¿™é‡Œä»…ä½œä¸ºæ¼”ç¤º
            // å®é™…ä½¿ç”¨æ—¶å¯ä»¥è®©ç®¡ç†å‘˜ä»£ä¸ºåˆ›å»ºï¼Œæˆ–è€…ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ’å…¥

            showToast('æ­¤åŠŸèƒ½éœ€è¦ç”¨æˆ·è‡ªå·±åœ¨å……å€¼ä¸­å¿ƒåˆ›å»º', 'warning');
            closeCreateModal();
        } catch (error) {
            showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
        }
    }

    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewOrderDetail(orderId, orderNo) {
        try {
            const data = await apiRequest(`/recharge/admin/orders?user_id=${0}`);
            // ç”±äºç®¡ç†å‘˜æ¥å£é™åˆ¶ï¼Œè¿™é‡Œè·å–æ‰€æœ‰è®¢å•åç­›é€‰
            const order = allOrders.find(o => o.order_no === orderNo);

            if (!order) {
                showToast('è®¢å•ä¸å­˜åœ¨', 'error');
                return;
            }

            // è·å–è¯¥è®¢å•çš„è½¬è´¦è®°å½•
            const transfers = allTransfers.filter(t => t.recharge_order_id === orderId);

            showOrderDetailModal(order, transfers);
        } catch (error) {
            showToast('è·å–è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
    function showOrderDetailModal(order, transfers) {
        const content = document.getElementById('orderDetailContent');
        const statusInfo = STATUS_MAP[order.status] || { label: order.status, class: '' };

        let html = `
            <div class="modal-detail-row">
                <span class="modal-detail-label">è®¢å•ID</span>
                <span class="modal-detail-value">${order.id}</span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">è®¢å•å·</span>
                <span class="modal-detail-value"><code>${order.order_no}</code></span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">ç”¨æˆ·ID</span>
                <span class="modal-detail-value">${order.user_id}</span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">å……å€¼é‡‘é¢</span>
                <span class="modal-detail-value" style="color:#10b981;font-size:18px;">Â¥${parseFloat(order.amount).toFixed(2)}</span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">è®¢å•çŠ¶æ€</span>
                <span class="modal-detail-value"><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></span>
            </div>
        `;

        if (order.alipay_trade_no) {
            html += `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¯ä»˜å®äº¤æ˜“å·</span>
                    <span class="modal-detail-value"><code>${order.alipay_trade_no}</code></span>
                </div>
            `;
        }

        html += `
            <div class="modal-detail-row">
                <span class="modal-detail-label">åˆ›å»ºæ—¶é—´</span>
                <span class="modal-detail-value">${formatDateTime(order.created_at)}</span>
            </div>
        `;

        if (order.paid_at) {
            html += `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¯ä»˜æ—¶é—´</span>
                    <span class="modal-detail-value">${formatDateTime(order.paid_at)}</span>
                </div>
            `;
        }

        if (order.confirmed_at) {
            html += `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">ç¡®è®¤æ—¶é—´</span>
                    <span class="modal-detail-value">${formatDateTime(order.confirmed_at)}</span>
                </div>
            `;
        }

        if (transfers.length > 0) {
            html += `<h4 style="margin:16px 0 8px;">åˆ†è´¦æ˜ç»†</h4>`;
            html += transfers.map(t => {
                const statusInfo = TRANSFER_STATUS_MAP[t.status] || { label: t.status, class: '' };

                return `
                    <div class="transfer-item">
                        <div class="transfer-item-header">
                            <span class="transfer-role">${ROLE_MAP[t.role] || t.role}</span>
                            <span class="transfer-status ${statusInfo.class}">${statusInfo.label}</span>
                        </div>
                        <div class="transfer-account">${t.alipay_account || 'æœªè®¾ç½®è´¦å·'}</div>
                        <div class="transfer-amount">Â¥${parseFloat(t.amount).toFixed(2)}</div>
                        ${t.fail_reason ? `<div style="color:#ef4444;font-size:12px;">å¤±è´¥åŸå› : ${t.fail_reason}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        content.innerHTML = html;
        document.getElementById('orderDetailModal').style.display = 'flex';
    }

    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
    function closeDetailModal() {
        document.getElementById('orderDetailModal').style.display = 'none';
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return '-';
        }
    }

    // å¯¼å‡ºå…¨å±€API
    window.AdminRecharge = {
        loadOrders,
        loadTransfers,
        applyFilters,
        resetFilters,
        resetTransferFilters,
        checkAllPayments,
        manualConfirmPayment,
        distributeOrder,
        showCreateModal,
        closeCreateModal,
        createOrder,
        viewOrderDetail,
        closeDetailModal
    };
})();
</script>

<style>
.modal-detail-row {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.modal-detail-row:last-child {
    border-bottom: none;
}

.modal-detail-label {
    width: 100px;
    color: #6b7280;
}

.modal-detail-value {
    flex: 1;
    font-weight: 500;
}

.transfer-item {
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 8px;
}

.transfer-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.transfer-role {
    font-weight: 500;
}

.transfer-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
}

.transfer-status.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.transfer-status.status-warning {
    background: #fef3c7;
    color: #92400e;
}

.transfer-status.status-success {
    background: #dcfce7;
    color: #166534;
}

.transfer-status.status-error {
    background: #fef2f2;
    color: #991b1b;
}

.transfer-status.status-disabled {
    background: #f3f4f6;
    color: #6b7280;
}

.transfer-account {
    font-size: 13px;
    color: #6b7280;
}

.transfer-amount {
    font-weight: 600;
    color: #10b981;
}

/* ç¡®è®¤æ”¯ä»˜æŒ‰é’®æ ·å¼ */
.btn-action-primary {
    background: #10b981;
    color: white;
}

.btn-action-primary:hover {
    background: #059669;
}
</style>
{% endblock %}
