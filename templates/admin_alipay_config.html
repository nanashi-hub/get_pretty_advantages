{% extends "base.html" %}

{% block title %}æ”¯ä»˜å®é…ç½® - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}æ”¯ä»˜å®é…ç½®ç®¡ç†{% endblock %}

{% block content %}
<div class="page-actions">
    <div class="action-group">
        <button class="btn btn-primary" onclick="AlipayConfig.showCreateModal()">
            <span class="icon">â•</span> æ·»åŠ é…ç½®
        </button>
        <button class="btn btn-secondary" onclick="AlipayConfig.loadConfigs()">
            <span class="icon">ğŸ”„</span> åˆ·æ–°
        </button>
    </div>
</div>

<!-- é…ç½®åˆ—è¡¨ -->
<div class="data-card">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="50">ID</th>
                    <th width="120">é…ç½®åç§°</th>
                    <th width="150">åº”ç”¨ID</th>
                    <th width="100">ç­¾åæ–¹å¼</th>
                    <th width="150">æ”¶æ¬¾è´¦å·</th>
                    <th>è´¹ç‡é…ç½®</th>
                    <th width="80">çŠ¶æ€</th>
                    <th width="180">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="configsTableBody">
                <tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- å½“å‰ç”Ÿæ•ˆé…ç½® -->
<div class="current-config-card" id="currentConfigCard" style="display: none;">
    <h3>å½“å‰ç”Ÿæ•ˆé…ç½®</h3>
    <div class="config-details" id="currentConfigDetails"></div>
    <div class="qrcode-section">
        <h4>æ”¶æ¬¾äºŒç»´ç </h4>
        <div class="qrcode-display">
            <img id="currentQrcode" src="" alt="æ”¶æ¬¾ç " onerror="this.style.display='none';document.getElementById('noQrcode').style.display='block';">
            <div id="noQrcode" style="display:none;text-align:center;padding:40px;color:#9ca3af;">
                <span style="font-size:40px;">ğŸ“·</span>
                <p>æœªè®¾ç½®æ”¶æ¬¾ç </p>
            </div>
        </div>
    </div>
</div>

<style>
.current-config-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.current-config-card h3 {
    margin-top: 0;
    margin-bottom: 16px;
    color: #1f2937;
}

.config-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.config-detail-item {
    display: flex;
    flex-direction: column;
}

.config-detail-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.config-detail-value {
    font-weight: 500;
    color: #1f2937;
}

.rate-preview {
    background: #f9fafb;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.rate-preview h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #6b7280;
}

.rate-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 14px;
}

.rate-role {
    color: #6b7280;
}

.rate-value {
    font-weight: 500;
    color: #1f2937;
}

.qrcode-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #6b7280;
}

.qrcode-display {
    display: flex;
    justify-content: center;
    padding: 20px;
    background: #f9fafb;
    border-radius: 8px;
}

.qrcode-display img {
    max-width: 300px;
    max-height: 300px;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.status-inactive {
    background: #f3f4f6;
    color: #6b7280;
}

.rates-tag {
    font-size: 12px;
    color: #6b7280;
}

.rates-tag code {
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 4px;
}
</style>

<!-- åˆ›å»º/ç¼–è¾‘é…ç½®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="configModal" style="display: none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="modalTitle">æ·»åŠ æ”¯ä»˜å®é…ç½®</h3>
            <button class="modal-close" onclick="AlipayConfig.closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="configForm">
                <input type="hidden" id="configId">

                <div class="form-section">
                    <h4>åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="form-group">
                        <label>é…ç½®åç§° <span class="required">*</span></label>
                        <input type="text" id="configName" required placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§ç¯å¢ƒ">
                    </div>
                    <div class="form-group">
                        <label>åº”ç”¨ID (App ID) <span class="required">*</span></label>
                        <input type="text" id="appId" required placeholder="æ”¯ä»˜å®å¼€æ”¾å¹³å°åº”ç”¨ID">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç­¾åæ–¹å¼</label>
                            <select id="signType">
                                <option value="RSA2">RSA2 (æ¨è)</option>
                                <option value="RSA">RSA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç½‘å…³åœ°å€</label>
                            <input type="text" id="gateway" value="https://openapi.alipay.com/gateway.do">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>å¯†é’¥é…ç½®</h4>
                    <div class="form-group">
                        <label>åº”ç”¨ç§é’¥ <span class="required">*</span></label>
                        <textarea id="privateKey" rows="4" required
                                  placeholder="è¯·è¾“å…¥åº”ç”¨ç§é’¥ï¼ˆPEMæ ¼å¼æˆ–åŸå§‹å¯†é’¥ï¼‰"></textarea>
                        <small class="form-hint">æ”¯æŒPEMæ ¼å¼æˆ–ç›´æ¥ç²˜è´´åŸå§‹å¯†é’¥å†…å®¹</small>
                    </div>
                    <div class="form-group">
                        <label>æ”¯ä»˜å®å…¬é’¥ <span class="required">*</span></label>
                        <textarea id="alipayPublicKey" rows="4" required
                                  placeholder="è¯·è¾“å…¥æ”¯ä»˜å®å…¬é’¥ï¼ˆPEMæ ¼å¼æˆ–åŸå§‹å¯†é’¥ï¼‰"></textarea>
                        <small class="form-hint">ä»æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–</small>
                    </div>
                </div>

                <div class="form-section">
                    <h4>æ”¶æ¬¾ä¿¡æ¯</h4>
                    <div class="form-group">
                        <label>å¹³å°æ”¯ä»˜å®è´¦å·</label>
                        <input type="text" id="alipayAccount" placeholder="ç”¨äºæ¥æ”¶å¹³å°åˆ†æˆçš„è´¦å·">
                    </div>
                    <div class="form-group">
                        <label>æ”¶æ¬¾ç å›¾ç‰‡</label>
                        <div class="qrcode-upload-area">
                            <input type="hidden" id="qrcodeUrl">
                            <div class="upload-preview" id="uploadPreview" style="display: none;">
                                <img id="previewImage" src="" alt="æ”¶æ¬¾ç é¢„è§ˆ">
                                <button type="button" class="btn btn-sm btn-danger remove-btn" onclick="AlipayConfig.removeQrcode()">âœ• ç§»é™¤</button>
                            </div>
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <input type="file" id="qrcodeFile" accept=".jpg,.jpeg,.png,.gif,.webp" onchange="AlipayConfig.handleFileSelect(event)" style="display:none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('qrcodeFile').click()">
                                    <span class="icon">ğŸ“·</span> é€‰æ‹©å›¾ç‰‡
                                </button>
                                <p class="upload-hint">æ”¯æŒ jpgã€pngã€gifã€webp æ ¼å¼ï¼Œä¸è¶…è¿‡5MB</p>
                            </div>
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                <span>ä¸Šä¼ ä¸­...</span>
                            </div>
                        </div>
                        <small class="form-hint">æˆ–ä»å·²ä¸Šä¼ çš„å›¾ç‰‡ä¸­é€‰æ‹©ï¼š<a href="javascript:;" onclick="AlipayConfig.showQrcodeGallery()">æŸ¥çœ‹å›¾åº“</a></small>
                    </div>
                </div>

                <div class="form-section">
                    <h4>åˆ†è´¦è´¹ç‡é…ç½®</h4>
                    <div class="form-group">
                        <label>å¹³å°æŠ½æˆæ¯”ä¾‹</label>
                        <input type="number" id="platformFeeRate" step="0.0001" min="0" max="1" value="0.1">
                        <small class="form-hint">ä¾‹å¦‚ï¼š0.1 è¡¨ç¤º 10%</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä¸€çº§ä»£ç†åˆ†æˆæ¯”ä¾‹</label>
                            <input type="number" id="agentL1Rate" step="0.0001" min="0" max="1" value="0.54">
                        </div>
                        <div class="form-group">
                            <label>äºŒçº§ä»£ç†åˆ†æˆæ¯”ä¾‹</label>
                            <input type="number" id="agentL2Rate" step="0.0001" min="0" max="1" value="0.27">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å·ä¸»åˆ†æˆæ¯”ä¾‹</label>
                        <input type="number" id="userRate" step="0.0001" min="0" max="1" value="0.09">
                        <small class="form-hint">æ³¨æ„ï¼šæ‰€æœ‰æ¯”ä¾‹ä¹‹å’Œä¸åº”è¶…è¿‡ 1ï¼ˆ100%ï¼‰</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="remark" placeholder="é…ç½®å¤‡æ³¨ä¿¡æ¯">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="AlipayConfig.closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="AlipayConfig.saveConfig()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹é…ç½®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="viewConfigModal" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3>é…ç½®è¯¦æƒ…</h3>
            <button class="modal-close" onclick="AlipayConfig.closeViewModal()">&times;</button>
        </div>
        <div class="modal-body" id="viewConfigContent">
            <!-- åŠ¨æ€å†…å®¹ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="AlipayConfig.closeViewModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æ”¶æ¬¾ç å›¾åº“æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="qrcodeGalleryModal" style="display: none;">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3>æ”¶æ¬¾ç å›¾åº“</h3>
            <button class="modal-close" onclick="AlipayConfig.closeGalleryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="gallery-grid" id="galleryGrid">
                <div class="gallery-loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="AlipayConfig.closeGalleryModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
(function() {
    let allConfigs = [];
    let editingConfigId = null;

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        setTimeout(initPage, 0);
    }

    async function initPage() {
        await loadConfigs();
    }

    // åŠ è½½é…ç½®åˆ—è¡¨
    async function loadConfigs() {
        const tbody = document.getElementById('configsTableBody');

        try {
            const configs = await apiRequest('/admin/alipay/configs');
            allConfigs = configs;
            renderConfigs(configs);
            updateCurrentConfigCard(configs);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="8" class="error-cell">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // æ¸²æŸ“é…ç½®åˆ—è¡¨
    function renderConfigs(configs) {
        const tbody = document.getElementById('configsTableBody');

        if (!configs || configs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— é…ç½®</td></tr>';
            return;
        }

        tbody.innerHTML = configs.map(config => {
            const isActive = config.status === 1;
            const statusBadge = isActive
                ? '<span class="status-badge status-active">ç”Ÿæ•ˆä¸­</span>'
                : '<span class="status-badge status-inactive">æœªå¯ç”¨</span>';

            const ratesHtml = `
                <div class="rates-tag">
                    <code>å¹³å° ${(config.platform_fee_rate * 100).toFixed(1)}%</code>
                    <code>+1 ${(config.agent_l1_rate * 100).toFixed(1)}%</code>
                    <code>+2 ${(config.agent_l2_rate * 100).toFixed(1)}%</code>
                    <code>å·ä¸» ${(config.user_rate * 100).toFixed(1)}%</code>
                </div>
            `;

            return `
                <tr>
                    <td>${config.id}</td>
                    <td><strong>${escapeHtml(config.name)}</strong></td>
                    <td><code style="font-size:12px;">${config.app_id}</code></td>
                    <td>${config.sign_type}</td>
                    <td>${escapeHtml(config.alipay_account || '-')}</td>
                    <td>${ratesHtml}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group-inline">
                            <button class="btn-action" onclick="AlipayConfig.viewConfig(${config.id})">æŸ¥çœ‹</button>
                            <button class="btn-action" onclick="AlipayConfig.editConfig(${config.id})">ç¼–è¾‘</button>
                            ${!isActive ? `<button class="btn-action" onclick="AlipayConfig.enableConfig(${config.id})">å¯ç”¨</button>` : ''}
                            <button class="btn-action danger" onclick="AlipayConfig.deleteConfig(${config.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // æ›´æ–°å½“å‰ç”Ÿæ•ˆé…ç½®å¡ç‰‡
    function updateCurrentConfigCard(configs) {
        const card = document.getElementById('currentConfigCard');
        const activeConfig = configs.find(c => c.status === 1);

        if (!activeConfig) {
            card.style.display = 'none';
            return;
        }

        card.style.display = 'block';

        document.getElementById('currentConfigDetails').innerHTML = `
            <div class="config-detail-item">
                <span class="config-detail-label">é…ç½®åç§°</span>
                <span class="config-detail-value">${escapeHtml(activeConfig.name)}</span>
            </div>
            <div class="config-detail-item">
                <span class="config-detail-label">åº”ç”¨ID</span>
                <span class="config-detail-value"><code>${activeConfig.app_id}</code></span>
            </div>
            <div class="config-detail-item">
                <span class="config-detail-label">å¹³å°æ”¯ä»˜å®è´¦å·</span>
                <span class="config-detail-value">${escapeHtml(activeConfig.alipay_account || 'æœªè®¾ç½®')}</span>
            </div>
            <div class="config-detail-item">
                <span class="config-detail-label">ç½‘å…³</span>
                <span class="config-detail-value"><code style="font-size:12px;">${activeConfig.gateway}</code></span>
            </div>
        `;

        // æ›´æ–°æ”¶æ¬¾ç 
        const qrcodeImg = document.getElementById('currentQrcode');
        if (activeConfig.qrcode_url) {
            qrcodeImg.src = activeConfig.qrcode_url;
            qrcodeImg.style.display = 'block';
            document.getElementById('noQrcode').style.display = 'none';
        } else {
            qrcodeImg.style.display = 'none';
            document.getElementById('noQrcode').style.display = 'block';
        }
    }

    // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
    function showCreateModal() {
        editingConfigId = null;
        document.getElementById('modalTitle').textContent = 'æ·»åŠ æ”¯ä»˜å®é…ç½®';
        document.getElementById('configForm').reset();
        document.getElementById('configId').value = '';

        // é»˜è®¤å€¼
        document.getElementById('signType').value = 'RSA2';
        document.getElementById('gateway').value = 'https://openapi.alipay.com/gateway.do';
        document.getElementById('platformFeeRate').value = '0.1';
        document.getElementById('agentL1Rate').value = '0.54';
        document.getElementById('agentL2Rate').value = '0.27';
        document.getElementById('userRate').value = '0.09';

        // é‡ç½®ä¸Šä¼ åŒºåŸŸ
        document.getElementById('qrcodeUrl').value = '';
        document.getElementById('uploadPlaceholder').style.display = 'block';
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadPreview').style.display = 'none';

        document.getElementById('configModal').style.display = 'flex';
    }

    // ç¼–è¾‘é…ç½®
    async function editConfig(configId) {
        const config = allConfigs.find(c => c.id === configId);
        if (!config) return;

        // è·å–å®Œæ•´é…ç½®ï¼ˆåŒ…å«å¯†é’¥ï¼‰
        try {
            const fullConfig = await apiRequest(`/admin/alipay/configs/${configId}?include_secrets=true`);

            editingConfigId = configId;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ”¯ä»˜å®é…ç½®';

            document.getElementById('configId').value = fullConfig.id;
            document.getElementById('configName').value = fullConfig.name;
            document.getElementById('appId').value = fullConfig.app_id;
            document.getElementById('signType').value = fullConfig.sign_type;
            document.getElementById('gateway').value = fullConfig.gateway;
            document.getElementById('alipayAccount').value = fullConfig.alipay_account || '';
            document.getElementById('platformFeeRate').value = fullConfig.platform_fee_rate;
            document.getElementById('agentL1Rate').value = fullConfig.agent_l1_rate;
            document.getElementById('agentL2Rate').value = fullConfig.agent_l2_rate;
            document.getElementById('userRate').value = fullConfig.user_rate;
            document.getElementById('remark').value = fullConfig.remark || '';

            // å¯†é’¥å­—æ®µå¯èƒ½è¢«éšè—æ˜¾ç¤º
            if (fullConfig.private_key) {
                document.getElementById('privateKey').value = fullConfig.private_key;
            }
            if (fullConfig.alipay_public_key) {
                document.getElementById('alipayPublicKey').value = fullConfig.alipay_public_key;
            }

            // å¤„ç†æ”¶æ¬¾ç å›¾ç‰‡é¢„è§ˆ
            const qrcodeUrl = fullConfig.qrcode_url || '';
            document.getElementById('qrcodeUrl').value = qrcodeUrl;
            if (qrcodeUrl) {
                document.getElementById('previewImage').src = qrcodeUrl;
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadPreview').style.display = 'inline-block';
            } else {
                document.getElementById('uploadPlaceholder').style.display = 'block';
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadPreview').style.display = 'none';
            }

            document.getElementById('configModal').style.display = 'flex';
        } catch (error) {
            showToast('è·å–é…ç½®è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
        const data = {
            name: document.getElementById('configName').value,
            app_id: document.getElementById('appId').value,
            private_key: document.getElementById('privateKey').value,
            alipay_public_key: document.getElementById('alipayPublicKey').value,
            sign_type: document.getElementById('signType').value,
            gateway: document.getElementById('gateway').value,
            alipay_account: document.getElementById('alipayAccount').value || null,
            qrcode_url: document.getElementById('qrcodeUrl').value || null,
            platform_fee_rate: parseFloat(document.getElementById('platformFeeRate').value) || 0,
            agent_l1_rate: parseFloat(document.getElementById('agentL1Rate').value) || 0,
            agent_l2_rate: parseFloat(document.getElementById('agentL2Rate').value) || 0,
            user_rate: parseFloat(document.getElementById('userRate').value) || 0,
            remark: document.getElementById('remark').value || null
        };

        // éªŒè¯
        if (!data.name || !data.app_id || !data.private_key || !data.alipay_public_key) {
            showToast('è¯·å¡«å†™å¿…å¡«å­—æ®µ', 'error');
            return;
        }

        // éªŒè¯è´¹ç‡æ€»å’Œ
        const totalRate = data.platform_fee_rate + data.agent_l1_rate + data.agent_l2_rate + data.user_rate;
        if (totalRate > 1) {
            showToast(`è´¹ç‡æ€»å’Œ (${(totalRate * 100).toFixed(1)}%) ä¸èƒ½è¶…è¿‡ 100%`, 'error');
            return;
        }

        try {
            showToast('æ­£åœ¨ä¿å­˜...', 'info');

            if (editingConfigId) {
                await apiRequest(`/admin/alipay/configs/${editingConfigId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                showToast('é…ç½®æ›´æ–°æˆåŠŸ', 'success');
            } else {
                await apiRequest('/admin/alipay/configs', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showToast('é…ç½®åˆ›å»ºæˆåŠŸ', 'success');
            }

            closeModal();
            await loadConfigs();
        } catch (error) {
            showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æŸ¥çœ‹é…ç½®
    async function viewConfig(configId) {
        try {
            const config = await apiRequest(`/admin/alipay/configs/${configId}?include_secrets=true`);

            const content = document.getElementById('viewConfigContent');
            content.innerHTML = `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">é…ç½®åç§°</span>
                    <span class="modal-detail-value">${escapeHtml(config.name)}</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">åº”ç”¨ID</span>
                    <span class="modal-detail-value"><code>${config.app_id}</code></span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">ç­¾åæ–¹å¼</span>
                    <span class="modal-detail-value">${config.sign_type}</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">ç½‘å…³</span>
                    <span class="modal-detail-value"><code style="font-size:12px;">${config.gateway}</code></span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">åº”ç”¨ç§é’¥</span>
                    <span class="modal-detail-value"><code style="font-size:11px;word-break:break-all;">${config.private_key ? config.private_key.substring(0, 50) + '...' : 'æœªè®¾ç½®'}</code></span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¯ä»˜å®å…¬é’¥</span>
                    <span class="modal-detail-value"><code style="font-size:11px;word-break:break-all;">${config.alipay_public_key ? config.alipay_public_key.substring(0, 50) + '...' : 'æœªè®¾ç½®'}</code></span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">å¹³å°è´¦å·</span>
                    <span class="modal-detail-value">${escapeHtml(config.alipay_account || 'æœªè®¾ç½®')}</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¶æ¬¾ç </span>
                    <span class="modal-detail-value">${config.qrcode_url || 'æœªè®¾ç½®'}</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">å¹³å°è´¹ç‡</span>
                    <span class="modal-detail-value">${(config.platform_fee_rate * 100).toFixed(1)}%</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">ä¸€çº§ä»£ç†</span>
                    <span class="modal-detail-value">${(config.agent_l1_rate * 100).toFixed(1)}%</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">äºŒçº§ä»£ç†</span>
                    <span class="modal-detail-value">${(config.agent_l2_rate * 100).toFixed(1)}%</span>
                </div>
                <div class="modal-detail-row">
                    <span class="modal-detail-label">å·ä¸»</span>
                    <span class="modal-detail-value">${(config.user_rate * 100).toFixed(1)}%</span>
                </div>
            `;

            document.getElementById('viewConfigModal').style.display = 'flex';
        } catch (error) {
            showToast('è·å–é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å¯ç”¨é…ç½®
    async function enableConfig(configId) {
        if (!confirm('ç¡®å®šè¦å¯ç”¨æ­¤é…ç½®å—ï¼Ÿå°†ç¦ç”¨å…¶ä»–é…ç½®ã€‚')) return;

        try {
            await apiRequest(`/admin/alipay/configs/${configId}/enable`, {
                method: 'POST'
            });
            showToast('å·²å¯ç”¨', 'success');
            await loadConfigs();
        } catch (error) {
            showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
        }
    }

    // åˆ é™¤é…ç½®
    async function deleteConfig(configId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

        try {
            await apiRequest(`/admin/alipay/configs/${configId}`, {
                method: 'DELETE'
            });
            showToast('å·²åˆ é™¤', 'success');
            await loadConfigs();
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        document.getElementById('configModal').style.display = 'none';
        editingConfigId = null;
    }

    // å…³é—­æŸ¥çœ‹æ¨¡æ€æ¡†
    function closeViewModal() {
        document.getElementById('viewConfigModal').style.display = 'none';
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== æ”¶æ¬¾ç ä¸Šä¼ ç›¸å…³å‡½æ•° ====================

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // éªŒè¯æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showToast('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹© jpgã€pngã€gif æˆ– webp å›¾ç‰‡', 'error');
            return;
        }

        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
            return;
        }

        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        document.getElementById('uploadPlaceholder').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'block';

        try {
            const formData = new FormData();
            formData.append('file', file);

            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/admin/alipay/upload-qrcode', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'ä¸Šä¼ å¤±è´¥');
            }

            // ä¸Šä¼ æˆåŠŸï¼Œæ˜¾ç¤ºé¢„è§ˆ
            document.getElementById('qrcodeUrl').value = result.url;
            document.getElementById('previewImage').src = result.url;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadPreview').style.display = 'inline-block';

            showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
        } catch (error) {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'block';
            showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
        }

        // é‡ç½®æ–‡ä»¶è¾“å…¥
        event.target.value = '';
    }

    // ç§»é™¤æ”¶æ¬¾ç 
    function removeQrcode() {
        document.getElementById('qrcodeUrl').value = '';
        document.getElementById('uploadPreview').style.display = 'none';
        document.getElementById('uploadPlaceholder').style.display = 'block';
    }

    // æ˜¾ç¤ºå›¾åº“æ¨¡æ€æ¡†
    async function showQrcodeGallery() {
        document.getElementById('qrcodeGalleryModal').style.display = 'flex';
        await loadGallery();
    }

    // å…³é—­å›¾åº“æ¨¡æ€æ¡†
    function closeGalleryModal() {
        document.getElementById('qrcodeGalleryModal').style.display = 'none';
    }

    // åŠ è½½å›¾åº“
    async function loadGallery() {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '<div class="gallery-loading">åŠ è½½ä¸­...</div>';

        try {
            const result = await apiRequest('/admin/alipay/qrcode-list');
            const files = result.files || [];

            if (files.length === 0) {
                grid.innerHTML = '<div class="gallery-empty">æš‚æ— å·²ä¸Šä¼ çš„å›¾ç‰‡</div>';
                return;
            }

            grid.innerHTML = files.map(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                const date = new Date(file.created_at).toLocaleString('zh-CN');
                return `
                    <div class="gallery-item" onclick="AlipayConfig.selectGalleryImage('${file.url}')">
                        <img src="${file.url}" alt="${file.filename}" loading="lazy">
                        <div class="gallery-item-info">
                            <div>${sizeKB} KB</div>
                            <div>${date}</div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); AlipayConfig.deleteGalleryImage('${file.filename}')">âœ•</button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            grid.innerHTML = `<div class="gallery-empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }

    // é€‰æ‹©å›¾åº“ä¸­çš„å›¾ç‰‡
    function selectGalleryImage(url) {
        document.getElementById('qrcodeUrl').value = url;
        document.getElementById('previewImage').src = url;
        document.getElementById('uploadPlaceholder').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadPreview').style.display = 'inline-block';
        closeGalleryModal();
        showToast('å·²é€‰æ‹©æ”¶æ¬¾ç å›¾ç‰‡', 'success');
    }

    // åˆ é™¤å›¾åº“ä¸­çš„å›¾ç‰‡
    async function deleteGalleryImage(filename) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å›¾ç‰‡å—ï¼Ÿ')) return;

        try {
            await apiRequest(`/admin/alipay/qrcode/${filename}`, {
                method: 'DELETE'
            });
            showToast('å›¾ç‰‡å·²åˆ é™¤', 'success');
            await loadGallery();
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„é¢„è§ˆçŠ¶æ€
    function updateUploadPreview(qrcodeUrl) {
        if (qrcodeUrl) {
            document.getElementById('qrcodeUrl').value = qrcodeUrl;
            document.getElementById('previewImage').src = qrcodeUrl;
            document.getElementById('uploadPlaceholder').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadPreview').style.display = 'inline-block';
        } else {
            document.getElementById('qrcodeUrl').value = '';
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadPreview').style.display = 'none';
        }
    }

    // å¯¼å‡ºå…¨å±€API
    window.AlipayConfig = {
        loadConfigs,
        showCreateModal,
        closeModal,
        saveConfig,
        editConfig,
        viewConfig,
        closeViewModal,
        enableConfig,
        deleteConfig,
        // æ–°å¢çš„ä¸Šä¼ ç›¸å…³å‡½æ•°
        handleFileSelect,
        removeQrcode,
        showQrcodeGallery,
        closeGalleryModal,
        selectGalleryImage,
        deleteGalleryImage
    };
})();
</script>

<style>
.form-section {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

.form-hint {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: #9ca3af;
}

.modal-detail-row {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.modal-detail-row:last-child {
    border-bottom: none;
}

.modal-detail-label {
    width: 100px;
    color: #6b7280;
    font-size: 13px;
}

.modal-detail-value {
    flex: 1;
    font-weight: 500;
    word-break: break-word;
}

/* æ”¶æ¬¾ç ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.qrcode-upload-area {
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #f9fafb;
    transition: border-color 0.2s;
}

.qrcode-upload-area:hover {
    border-color: #9ca3af;
}

.upload-preview {
    position: relative;
    display: inline-block;
}

.upload-preview img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.upload-preview .remove-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 28px;
    height: 28px;
    padding: 0;
    font-size: 14px;
    border-radius: 50%;
    background: #ef4444;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-placeholder {
    padding: 20px 0;
}

.upload-hint {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 8px;
    margin-bottom: 0;
}

.upload-progress {
    padding: 20px 0;
}

.progress-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    width: 0%;
    transition: width 0.3s;
    animation: progressPulse 1s ease-in-out infinite;
}

@keyframes progressPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* å›¾åº“æ ·å¼ */
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    max-height: 400px;
    overflow-y: auto;
    padding: 4px;
}

.gallery-item {
    position: relative;
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
    background: #f9fafb;
}

.gallery-item:hover {
    border-color: #3b82f6;
    transform: scale(1.02);
}

.gallery-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.gallery-item-info {
    padding: 8px;
    font-size: 11px;
    color: #6b7280;
    background: white;
}

.gallery-item .delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    padding: 0;
    font-size: 12px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    cursor: pointer;
    display: none;
}

.gallery-item:hover .delete-btn {
    display: flex;
    align-items: center;
    justify-content: center;
}

.gallery-loading, .gallery-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px;
    color: #9ca3af;
}
</style>
{% endblock %}
