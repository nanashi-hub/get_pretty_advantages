{% extends "base.html" %}

{% block title %}用户管理 - 快手账号管理平台{% endblock %}

{% block page_title %}用户管理{% endblock %}

{% block content %}
<div class="page-actions">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索用户名/手机号/昵称..." onkeyup="handleSearch(event)">
        <button class="btn btn-secondary" onclick="applySearch()">搜索</button>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-group">
        <label>角色:</label>
        <select id="roleFilter">
            <option value="">全部</option>
            <option value="admin">管理员</option>
            <option value="agent">代理</option>
            <option value="normal">普通用户</option>
        </select>
    </div>
    <div class="filter-group">
        <label>状态:</label>
        <select id="statusFilter">
            <option value="">全部</option>
            <option value="1">正常</option>
            <option value="0">禁用</option>
        </select>
    </div>
    <div class="filter-group">
        <button class="btn btn-secondary" onclick="applyFilters()">筛选</button>
        <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
    </div>
    <div class="filter-stats">
        <span>共 <strong id="totalCount">0</strong> 个用户</span>
        <span id="filteredInfo" style="display:none;">（筛选后 <strong id="filteredCount">0</strong> 个）</span>
    </div>
</div>

<div class="data-card">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="60">ID</th>
                    <th width="120">用户名</th>
                    <th width="100">昵称</th>
                    <th width="120">手机号</th>
                    <th width="120">微信ID</th>
                    <th>KSCK账号</th>
                    <th width="80">角色</th>
                    <th width="60">状态</th>
                    <th width="100">注册时间</th>
                    <th width="180">操作</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <tr><td colspan="10" class="loading-cell">加载中...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.filter-group select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-right: 8px;
}
.filter-group button {
    margin-right: 4px;
}
.filter-stats {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}

/* KSCK 标签样式 */
.ksck-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}
.ksck-tag {
    display: inline-block;
    padding: 3px 8px;
    font-size: 12px;
    border-radius: 4px;
    font-weight: 500;
}
.ksck-valid {
    background: #dcfce7;
    color: #166534;
}
.ksck-invalid {
    background: #fef2f2;
    color: #991b1b;
}
.ksck-empty {
    color: #9ca3af;
    font-size: 12px;
}

/* 操作按钮样式 */
.action-cell {
    padding: 8px 12px;
}
.btn-group-inline {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}
.btn-action {
    padding: 4px 10px;
    font-size: 12px;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-action:hover {
    background: #e5e7eb;
}
.btn-action.danger {
    background: #fef2f2;
    border-color: #fecdd3;
    color: #dc2626;
}
.btn-action.danger:hover {
    background: #fee2e2;
}
</style>

<!-- 编辑用户模态框 -->
<div class="modal-overlay" id="editUserModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>编辑用户</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="editUsername" disabled style="background: #f3f4f6;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>昵称</label>
                        <input type="text" id="editNickname" placeholder="昵称">
                    </div>
                    <div class="form-group">
                        <label>手机号</label>
                        <input type="text" id="editPhone" placeholder="手机号">
                    </div>
                </div>
                <div class="form-group">
                    <label>微信ID</label>
                    <input type="text" id="editWechatId" placeholder="微信ID">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>角色</label>
                        <select id="editRole">
                            <option value="admin">管理员</option>
                            <option value="agent">代理</option>
                            <option value="normal">普通用户</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select id="editStatus">
                            <option value="1">正常</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">取消</button>
            <button class="btn btn-primary" onclick="saveUser()">保存</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ==================== 数据状态 ====================
    let allUsers = [];
    let filteredUsers = [];

    // 获取当前用户（从 localStorage 或直接调用）
    const getCurrentUserSafe = function() {
        try {
            return getCurrentUser();
        } catch (e) {
            const userStr = localStorage.getItem('current_user');
            return userStr ? JSON.parse(userStr) : null;
        }
    };
    const currentUser = getCurrentUserSafe();

    const ROLE_MAP = {
        'admin': '管理员',
        'agent': '代理',
        'normal': '普通用户'
    };

    // ==================== 初始化 ====================
    // 使用 DOMContentLoaded 或立即执行（如果已加载）
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        // DOM 已经加载完成，立即执行
        setTimeout(initPage, 0);
    }

    async function initPage() {
        await loadUsers();
        updateStats();
    }

    // ==================== 数据加载 ====================
    async function loadUsers() {
        const tbody = document.getElementById('usersTableBody');
        try {
            const response = await apiRequest('/admin/users');
            // 确保是数组
            allUsers = Array.isArray(response) ? response : [];
            filteredUsers = [...allUsers];
            renderTable(filteredUsers);
            updateStats();
        } catch (error) {
            console.error('加载用户失败:', error);
            tbody.innerHTML = `<tr><td colspan="10" class="error-cell">加载失败: ${error.message}</td></tr>`;
        }
    }

    // ==================== 渲染逻辑 ====================
    function renderTable(users) {
        const tbody = document.getElementById('usersTableBody');

        if (!users || users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-cell">暂无用户数据</td></tr>';
            return;
        }

        const html = users.map(user => renderUserRow(user)).join('');
        tbody.innerHTML = html;
    }

    function renderUserRow(user) {
        const ksckHtml = renderKsckTags(user.ksck_list);
        const roleBadge = renderRoleBadge(user.role);
        const statusBadge = renderStatusBadge(user.status);
        const dateStr = formatDate(user.created_at);

        return `
            <tr>
                <td>${user.id}</td>
                <td><strong>${escapeHtml(user.username)}</strong></td>
                <td>${escapeHtml(user.nickname || '-')}</td>
                <td>${escapeHtml(user.phone || '-')}</td>
                <td>${escapeHtml(user.wechat_id || '-')}</td>
                <td>${ksckHtml}</td>
                <td>${roleBadge}</td>
                <td>${statusBadge}</td>
                <td>${dateStr}</td>
                <td class="action-cell">
                    <div class="btn-group-inline">
                        <button class="btn-action" onclick="AdminUsers.editUser(${user.id})">编辑</button>
                        <button class="btn-action" onclick="AdminUsers.toggleStatus(${user.id})">${user.status === 1 ? '禁用' : '启用'}</button>
                        <button class="btn-action danger" onclick="AdminUsers.deleteUser(${user.id})">删除</button>
                    </div>
                </td>
            </tr>
        `;
    }

    function renderKsckTags(ksckList) {
        if (!ksckList || ksckList.length === 0) {
            return '<span class="ksck-empty">暂无</span>';
        }

        const tags = ksckList.map(ksck => {
            const status = String(ksck.status || '').toLowerCase();
            const isValid = status === 'valid' || (!status.includes('invalid') && status.includes('valid'));
            const className = isValid ? 'ksck-valid' : 'ksck-invalid';
            const title = isValid ? '启用' : '禁用';
            return `<span class="ksck-tag ${className}" title="${title}">${escapeHtml(ksck.name)}</span>`;
        }).join('');

        return `<div class="ksck-tags">${tags}</div>`;
    }

    function renderRoleBadge(role) {
        const label = ROLE_MAP[role] || role;
        return `<span class="role-badge role-${role}">${label}</span>`;
    }

    function renderStatusBadge(status) {
        const isActive = status === 1;
        const className = isActive ? 'status-normal' : 'status-disabled';
        const label = isActive ? '正常' : '禁用';
        return `<span class="status-badge ${className}">${label}</span>`;
    }

    // ==================== 筛选逻辑 ====================
    function applyFilters() {
        const roleValue = document.getElementById('roleFilter').value;
        const statusValue = document.getElementById('statusFilter').value;

        filteredUsers = allUsers.filter(user => {
            // 角色筛选
            if (roleValue && user.role !== roleValue) {
                return false;
            }
            // 状态筛选
            if (statusValue !== '' && user.status !== parseInt(statusValue)) {
                return false;
            }
            return true;
        });

        renderTable(filteredUsers);
        updateStats();
    }

    function applySearch() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();

        if (!keyword) {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => {
                const username = String(user.username || '').toLowerCase();
                const phone = String(user.phone || '').toLowerCase();
                const nickname = String(user.nickname || '').toLowerCase();
                return username.includes(keyword) ||
                       phone.includes(keyword) ||
                       nickname.includes(keyword);
            });
        }

        renderTable(filteredUsers);
        updateStats();
    }

    function handleSearch(event) {
        if (event.key === 'Enter') {
            applySearch();
        }
    }

    function resetFilters() {
        document.getElementById('roleFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        filteredUsers = [...allUsers];
        renderTable(filteredUsers);
        updateStats();
    }

    // ==================== 统计更新 ====================
    function updateStats() {
        document.getElementById('totalCount').textContent = allUsers.length;
        const filteredInfo = document.getElementById('filteredInfo');
        if (filteredUsers.length !== allUsers.length) {
            document.getElementById('filteredCount').textContent = filteredUsers.length;
            filteredInfo.style.display = 'inline';
        } else {
            filteredInfo.style.display = 'none';
        }
    }

    // ==================== 用户操作 ====================
    function editUser(id) {
        const user = allUsers.find(u => u.id === id);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editNickname').value = user.nickname || '';
        document.getElementById('editPhone').value = user.phone || '';
        document.getElementById('editWechatId').value = user.wechat_id || '';
        document.getElementById('editRole').value = user.role;
        document.getElementById('editStatus').value = user.status;

        document.getElementById('editUserModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editUserModal').style.display = 'none';
    }

    async function saveUser() {
        const id = document.getElementById('editUserId').value;
        const data = {
            nickname: document.getElementById('editNickname').value || null,
            phone: document.getElementById('editPhone').value || null,
            wechat_id: document.getElementById('editWechatId').value || null,
            role: document.getElementById('editRole').value,
            status: parseInt(document.getElementById('editStatus').value)
        };

        try {
            await apiRequest(`/admin/users/${id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            showToast('用户更新成功', 'success');
            closeEditModal();
            await loadUsers();
        } catch (error) {
            showToast('更新失败: ' + error.message, 'error');
        }
    }

    async function toggleStatus(id) {
        const user = allUsers.find(u => u.id === id);
        if (!user) return;

        const newStatus = user.status === 1 ? 0 : 1;
        const action = newStatus === 1 ? '启用' : '禁用';

        if (!confirm(`确定要${action}用户 ${user.username} 吗？`)) return;

        try {
            await apiRequest(`/admin/users/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ status: newStatus })
            });
            showToast(`已${action}`, 'success');
            await loadUsers();
        } catch (error) {
            showToast('操作失败: ' + error.message, 'error');
        }
    }

    async function deleteUser(id) {
        const user = allUsers.find(u => u.id === id);
        if (!user) return;

        if (currentUser && currentUser.id === id) {
            showToast('不能删除自己', 'warning');
            return;
        }

        if (!confirm(`确定要删除用户 ${user.username} 吗？此操作不可恢复。`)) return;

        try {
            await apiRequest(`/admin/users/${id}`, { method: 'DELETE' });
            showToast('已删除', 'success');
            await loadUsers();
        } catch (error) {
            showToast('删除失败: ' + error.message, 'error');
        }
    }

    // ==================== 工具函数 ====================
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            return new Date(dateStr).toLocaleDateString('zh-CN');
        } catch {
            return '-';
        }
    }

    // ==================== 导出全局API ====================
    window.AdminUsers = {
        editUser,
        toggleStatus,
        deleteUser
    };

    // 导出筛选函数到全局作用域
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.applySearch = applySearch;
    window.handleSearch = handleSearch;

    // 导出模态框相关函数到全局作用域（供HTML中的onclick使用）
    window.closeEditModal = closeEditModal;
    window.saveUser = saveUser;

})();
</script>
{% endblock %}
