{% extends "base.html" %}

{% block title %}ç¼´è´¹å®¡æ ¸ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}ç¼´è´¹å®¡æ ¸{% endblock %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="admin-header-card">
    <div class="admin-header-info">
        <div class="admin-header-title">
            <span class="admin-icon">ğŸ“Š</span>
            <div>
                <h3>ç»“ç®—ç®¡ç†</h3>
                <p class="admin-subtitle">ç»“ç®—æœŸç®¡ç†ä¸ç¼´è´¹å®¡æ ¸</p>
            </div>
        </div>
        <div class="admin-actions">
            <button class="btn-admin-action" onclick="loadPeriods()">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<!-- åˆ›å»ºç»“ç®—æœŸå¡ç‰‡ -->
<div class="admin-section-card create-period-card">
    <div class="admin-section-header">
        <h3>â• åˆ›å»ºç»“ç®—æœŸ</h3>
    </div>
    <div class="admin-section-body">
        <form id="periodForm" class="period-form-grid">
            <!-- ç¬¬ä¸€è¡Œï¼šç»Ÿè®¡å‘¨æœŸ -->
            <div class="form-field-group">
                <label for="periodStart">ç»Ÿè®¡å¼€å§‹æ—¥ <span class="required-mark">*</span></label>
                <input type="date" id="periodStart" required>
            </div>
            <div class="form-field-group">
                <label for="periodEnd">ç»Ÿè®¡ç»“æŸæ—¥ <span class="required-mark">*</span></label>
                <input type="date" id="periodEnd" required>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šç¼´è´¹çª—å£ -->
            <div class="form-field-group">
                <label for="payStart">ç¼´è´¹å¼€å§‹æ—¥ <span class="required-mark">*</span></label>
                <input type="date" id="payStart" required>
            </div>
            <div class="form-field-group">
                <label for="payEnd">ç¼´è´¹æˆªæ­¢æ—¥ <span class="required-mark">*</span></label>
                <input type="date" id="payEnd" required>
            </div>

            <!-- ç¬¬ä¸‰è¡Œï¼šè´¹ç‡è®¾ç½® -->
            <div class="form-field-group">
                <label for="coinRate">å…‘æ¢æ¯”ä¾‹</label>
                <input type="number" id="coinRate" min="1" step="1" value="10000">
                <span class="input-hint">coins = 1å…ƒ</span>
            </div>
            <div class="form-field-group">
                <label for="periodStatus">åˆå§‹çŠ¶æ€</label>
                <select id="periodStatus">
                    <option value="0">ğŸŸ¢ OPENï¼ˆå¼€å¯ä¸­ï¼‰</option>
                    <option value="1">ğŸŸ¡ PAYINGï¼ˆç¼´è´¹ä¸­ï¼‰</option>
                    <option value="2">ğŸ”´ CLOSEDï¼ˆå·²å…³é—­ï¼‰</option>
                </select>
            </div>

            <!-- ç¬¬å››è¡Œï¼šåˆ†æˆæ¯”ä¾‹ -->
            <div class="form-field-group">
                <label for="hostBps">å·ä¸»è‡ªç•™</label>
                <input type="number" id="hostBps" min="0" max="10000" step="1" value="6000">
                <span class="input-hint">bpsï¼ˆåŸºç‚¹ï¼Œä¸‡åˆ†ä¹‹ä¸€ï¼‰</span>
            </div>
            <div class="form-field-group">
                <label for="collectBps">å¹³å°åº”æ”¶</label>
                <input type="number" id="collectBps" min="0" max="10000" step="1" value="4000">
                <span class="input-hint">bpsï¼ˆåº”ç¼´å¹³å°ï¼‰</span>
            </div>

            <!-- ç¬¬äº”è¡Œï¼šä¸Šä¸‹çº§åˆ†æˆ -->
            <div class="form-field-group">
                <label for="l1Bps">+1 çº§åˆ†æˆ</label>
                <input type="number" id="l1Bps" min="0" max="10000" step="1" value="2000">
                <span class="input-hint">ç›´æ¥ä¸‹çº§åˆ†æˆ</span>
            </div>
            <div class="form-field-group">
                <label for="l2Bps">+2 çº§åˆ†æˆ</label>
                <input type="number" id="l2Bps" min="0" max="10000" step="1" value="400">
                <span class="input-hint">é—´æ¥ä¸‹çº§åˆ†æˆ</span>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="form-actions-full">
                <button type="button" class="btn-primary-action" onclick="createPeriod()">
                    <span>â•</span> åˆ›å»ºç»“ç®—æœŸ
                </button>
            </div>
        </form>
        <div class="form-hint">
            ğŸ’¡ è¯´æ˜ï¼šåˆ›å»ºåéœ€è¦ç‚¹å‡»å¯¹åº”ç»“ç®—æœŸçš„ã€Œç”Ÿæˆã€æŒ‰é’®æ¥å†™å…¥å¿«ç…§/æ±‡æ€»/åº”ç¼´æ•°æ®
        </div>
    </div>
</div>

<!-- ç»“ç®—æœŸåˆ—è¡¨ -->
<div class="admin-section-card periods-list-card">
    <div class="admin-section-header">
        <h3>ğŸ“… ç»“ç®—æœŸåˆ—è¡¨</h3>
        <span class="record-count-badge" id="periodCountBadge">0 æ¡</span>
    </div>
    <div class="admin-section-body">
        <div class="table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-period">ç»Ÿè®¡å‘¨æœŸ</th>
                        <th class="col-window">ç¼´è´¹çª—å£</th>
                        <th class="col-rate">è´¹ç‡</th>
                        <th class="col-bps">åˆ†æˆæ¯”ä¾‹</th>
                        <th class="col-status">çŠ¶æ€</th>
                        <th class="col-actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="periodTableBody">
                    <tr><td colspan="7" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ç¼´è´¹å®¡æ ¸ -->
<div class="admin-section-card audit-card">
    <div class="admin-section-header">
        <h3>ğŸ” ç¼´è´¹å®¡æ ¸</h3>
        <div class="filter-group">
            <select id="paymentPeriodFilter" onchange="loadPayments()">
                <option value="">å…¨éƒ¨ç»“ç®—æœŸ</option>
            </select>
            <select id="paymentStatusFilter" onchange="loadPayments()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="0">â³ å¾…å®¡æ ¸</option>
                <option value="1">âœ… å·²ç¡®è®¤</option>
                <option value="2">âŒ å·²é©³å›</option>
            </select>
            <button class="btn-filter" onclick="loadPayments()">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
    <div class="admin-section-body">
        <div class="table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-period-id">æœŸID</th>
                        <th class="col-user">ç”¨æˆ·ID</th>
                        <th class="col-amount">é‡‘é¢</th>
                        <th class="col-method">æ–¹å¼</th>
                        <th class="col-proof">å‡­è¯</th>
                        <th class="col-time">æäº¤æ—¶é—´</th>
                        <th class="col-status">çŠ¶æ€</th>
                        <th class="col-time">å®¡æ ¸æ—¶é—´</th>
                        <th class="col-actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="paymentAuditTableBody">
                    <tr><td colspan="10" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* é¡µé¢å¤´éƒ¨ */
.admin-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
}

.admin-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.admin-icon {
    font-size: 48px;
    background: rgba(255,255,255,0.2);
    width: 72px;
    height: 72px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-header-title h3 {
    margin: 0;
    color: white;
    font-size: 20px;
    font-weight: 600;
}

.admin-subtitle {
    margin: 4px 0 0 0;
    color: rgba(255,255,255,0.8);
    font-size: 14px;
}

.admin-actions {
    display: flex;
    gap: 12px;
}

.btn-admin-action {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-admin-action:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
}

/* å¡ç‰‡é€šç”¨æ ·å¼ */
.admin-section-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    overflow: hidden;
}

.admin-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: #f8fafc;
}

.admin-section-header h3 {
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-color);
}

.admin-section-body {
    padding: 20px;
}

/* åˆ›å»ºç»“ç®—æœŸå¡ç‰‡ */
.create-period-card {
    border-left: 4px solid #667eea;
}

/* ç»“ç®—æœŸåˆ—è¡¨å¡ç‰‡ */
.periods-list-card {
    border-left: 4px solid #10b981;
}

/* å®¡æ ¸å¡ç‰‡ */
.audit-card {
    border-left: 4px solid #f59e0b;
}

/* è®°å½•æ•°é‡å¾½ç«  */
.record-count-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: rgba(102, 126, 234, 0.1);
    color: #6366f1;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
}

/* è¡¨å•ç½‘æ ¼ */
.period-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px 20px;
}

.form-field-group {
    display: flex;
    flex-direction: column;
}

.form-field-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 6px;
}

.form-field-group input,
.form-field-group select {
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
}

.form-field-group input:focus,
.form-field-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.required-mark {
    color: #ef4444;
    font-weight: 600;
    margin-left: 2px;
}

.input-hint {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

.form-actions-full {
    grid-column: 1 / -1;
    display: flex;
    justify-content: flex-start;
    margin-top: 8px;
}

.btn-primary-action {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.form-hint {
    grid-column: 1 / -1;
    padding: 10px 14px;
    background: rgba(102, 126, 234, 0.08);
    border-radius: 8px;
    font-size: 13px;
    color: #6366f1;
    margin-top: 4px;
}

/* ç­›é€‰ç»„ */
.filter-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-group select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    background: white;
}

.filter-group select:focus {
    outline: none;
    border-color: #667eea;
}

.btn-filter {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 14px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-filter:hover {
    background: #f8fafc;
    border-color: #667eea;
}

/* è¡¨æ ¼æ ·å¼ */
.table-wrapper {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid var(--border-color);
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.admin-table thead {
    background: linear-gradient(180deg, rgba(102, 126, 234, 0.08) 0%, rgba(102, 126, 234, 0.03) 100%);
}

.admin-table thead th {
    text-align: left;
    padding: 12px 14px;
    font-size: 12px;
    font-weight: 600;
    color: #6366f1;
    letter-spacing: 0.3px;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    white-space: nowrap;
}

.admin-table tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    color: var(--text-color);
    vertical-align: middle;
}

.admin-table tbody tr:last-child td {
    border-bottom: none;
}

.admin-table tbody tr {
    transition: all 0.15s ease;
}

.admin-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.04);
}

/* åˆ—å®½ */
.admin-table thead th.col-id {
    width: 60px;
    text-align: center;
}

.admin-table thead th.col-period {
    width: 160px;
}

.admin-table thead th.col-window {
    width: 160px;
}

.admin-table thead th.col-rate {
    width: 80px;
    text-align: center;
}

.admin-table thead th.col-bps {
    min-width: 200px;
}

.admin-table thead th.col-period-id {
    width: 70px;
    text-align: center;
}

.admin-table thead th.col-user {
    width: 80px;
    text-align: center;
}

.admin-table thead th.col-amount {
    width: 100px;
    text-align: right;
}

.admin-table thead th.col-method {
    width: 80px;
}

.admin-table thead th.col-proof {
    width: 70px;
    text-align: center;
}

.admin-table thead th.col-time {
    width: 140px;
}

.admin-table tbody td.col-id,
.admin-table tbody td.col-period-id,
.admin-table tbody td.col-user {
    text-align: center;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    color: var(--text-muted);
}

.admin-table tbody td.col-amount {
    text-align: right;
    font-weight: 600;
    color: #10b981;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.status-badge.status-open {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-badge.status-closed {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.status-badge.status-pending {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

.status-badge.status-paid {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-badge.status-invalid {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.status-badge.status-active {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1d4ed8;
}

.period-active-row {
    background: rgba(59, 130, 246, 0.06);
}

/* æ“ä½œå•å…ƒæ ¼ */
.action-cell {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.action-cell .btn {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.action-cell .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.action-cell .btn-primary:hover {
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.action-cell .btn-secondary {
    background: white;
    color: #6366f1;
    border: 1px solid rgba(102, 126, 234, 0.2);
}

.action-cell .btn-secondary:hover {
    background: #6366f1;
    color: white;
    border-color: #6366f1;
}

.action-cell .btn-danger {
    background: white;
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.25);
}

.action-cell .btn-danger:hover {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
}

/* è¡¨æ ¼é“¾æ¥ */
.admin-table a {
    color: #6366f1;
    text-decoration: none;
}

.admin-table a:hover {
    text-decoration: underline;
}

/* ç©ºçŠ¶æ€ */
.loading-cell,
.empty-cell,
.error-cell {
    text-align: center !important;
    padding: 40px 20px !important;
    color: var(--text-muted);
    font-size: 14px;
}

.loading-cell::before {
    content: '';
    display: block;
    width: 32px;
    height: 32px;
    margin: 0 auto 12px;
    border: 3px solid rgba(102, 126, 234, 0.1);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-cell {
    color: #ef4444;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function formatStatusBadge(type, text) {
    return `<span class="status-badge status-${type}">${text}</span>`;
}

function paymentStatusLabel(status) {
    const s = Number(status);
    if (s === 1) return { type: 'paid', text: 'å·²ç¡®è®¤' };
    if (s === 2) return { type: 'invalid', text: 'å·²é©³å›' };
    return { type: 'pending', text: 'å¾…å®¡æ ¸' };
}

function periodStatusLabel(status) {
    const s = Number(status);
    if (s === 2) return { type: 'closed', text: 'CLOSED' };
    if (s === 1) return { type: 'pending', text: 'PAYING' };
    return { type: 'open', text: 'OPEN' };
}

async function loadPeriods() {
    const body = document.getElementById('periodTableBody');
    const periodFilter = document.getElementById('paymentPeriodFilter');
    body.innerHTML = '<tr><td colspan="7" class="loading-cell">åŠ è½½ä¸­...</td></tr>';
    periodFilter.innerHTML = '<option value="">å…¨éƒ¨ç»“ç®—æœŸ</option>';

    try {
        const periods = await apiRequest('/settlement-periods');
        if (!Array.isArray(periods) || periods.length === 0) {
            body.innerHTML = '<tr><td colspan="7" class="empty-cell">æš‚æ— ç»“ç®—æœŸ</td></tr>';
            updatePeriodCount(0);
            return;
        }

        periods.forEach(p => {
            const opt = document.createElement('option');
            opt.value = String(p.period_id);
            opt.textContent = `${p.period_id}ï¼ˆ${p.period_start}~${p.period_end}ï¼‰`;
            periodFilter.appendChild(opt);
        });

        body.innerHTML = periods.map(p => {
            const st = periodStatusLabel(p.status);
            const isActive = Number(p.is_active || 0) === 1;
            const bps = `<span style="font-size:11px;color:#64748b;">è‡ªç•™:${p.host_bps} | å¹³å°:${p.collect_bps} | +1:${p.l1_bps} | +2:${p.l2_bps}</span>`;
            return `
                <tr class="${isActive ? 'period-active-row' : ''}">
                    <td class="col-id">${p.period_id}</td>
                    <td>${p.period_start} ~ ${p.period_end}</td>
                    <td>${p.pay_start} ~ ${p.pay_end}</td>
                    <td style="text-align:center;">${p.coin_rate}</td>
                    <td>${bps}</td>
                    <td>
                        ${formatStatusBadge(st.type, st.text)}
                        ${isActive ? formatStatusBadge('active', 'ç”Ÿæ•ˆ') : ''}
                    </td>
                    <td class="action-cell">
                        ${isActive ? `<button class="btn btn-secondary btn-sm" disabled>å·²åº”ç”¨</button>` : `<button class="btn btn-primary btn-sm" onclick="activatePeriod(${p.period_id})">åº”ç”¨</button>`}
                        <button class="btn btn-primary btn-sm" onclick="generatePeriod(${p.period_id}, false)">ç”Ÿæˆ</button>
                        <button class="btn btn-secondary btn-sm" onclick="generatePeriod(${p.period_id}, true)">é‡è·‘</button>
                        <button class="btn btn-secondary btn-sm" onclick="generateCommissions(${p.period_id})">è¡¥åˆ†æˆ</button>
                        <button class="btn btn-secondary btn-sm" onclick="unlockCommissions(${p.period_id})">è§£é”</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePeriod(${p.period_id}, '${p.period_start}~${p.period_end}')">åˆ é™¤</button>
                    </td>
                </tr>
            `;
        }).join('');
        updatePeriodCount(periods.length);
    } catch (error) {
        body.innerHTML = `<tr><td colspan="7" class="error-cell">${error.message || 'åŠ è½½å¤±è´¥'}</td></tr>`;
    }
}

function updatePeriodCount(count) {
    const badge = document.getElementById('periodCountBadge');
    if (badge) {
        badge.textContent = `${count} æ¡`;
    }
}

async function createPeriod() {
    const periodStart = document.getElementById('periodStart').value;
    const periodEnd = document.getElementById('periodEnd').value;
    const payStart = document.getElementById('payStart').value;
    const payEnd = document.getElementById('payEnd').value;

    if (!periodStart || !periodEnd || !payStart || !payEnd) {
        showToast('è¯·å¡«å†™å®Œæ•´æ—¥æœŸ', 'error');
        return;
    }

    const payload = {
        period_start: periodStart,
        period_end: periodEnd,
        pay_start: payStart,
        pay_end: payEnd,
        coin_rate: Number(document.getElementById('coinRate').value || 10000),
        host_bps: Number(document.getElementById('hostBps').value || 6000),
        l1_bps: Number(document.getElementById('l1Bps').value || 2000),
        l2_bps: Number(document.getElementById('l2Bps').value || 400),
        collect_bps: Number(document.getElementById('collectBps').value || 4000),
        status: Number(document.getElementById('periodStatus').value || 0)
    };

    try {
        await apiRequest('/settlement-periods', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        showToast('ç»“ç®—æœŸå·²åˆ›å»º', 'success');
        await loadPeriods();
    } catch (error) {
        showToast(error.message || 'åˆ›å»ºå¤±è´¥', 'error');
    }
}

async function generatePeriod(periodId, regenerate) {
    if (regenerate) {
        const ok = confirm('é‡è·‘ä¼šæ¸…ç©ºè¯¥æœŸçš„å¿«ç…§/æ±‡æ€»/åº”ç¼´æ•°æ®ï¼ˆå·²å­˜åœ¨ç¼´è´¹è®°å½•å°†è¢«é˜»æ­¢ï¼‰ã€‚ç¡®è®¤ç»§ç»­ï¼Ÿ');
        if (!ok) return;
    }

    try {
        const url = `/settlement-periods/${periodId}/generate?regenerate=${regenerate ? 'true' : 'false'}`;
        await apiRequest(url, { method: 'POST' });
        showToast('ç”ŸæˆæˆåŠŸ', 'success');
    } catch (error) {
        showToast(error.message || 'ç”Ÿæˆå¤±è´¥', 'error');
    }
}

async function generateCommissions(periodId) {
    try {
        await apiRequest(`/settlement-periods/${periodId}/generate-commissions`, { method: 'POST' });
        showToast('å·²è¡¥ç”Ÿæˆåˆ†æˆæ˜ç»†', 'success');
    } catch (error) {
        showToast(error.message || 'è¡¥ç”Ÿæˆå¤±è´¥', 'error');
    }
}

async function unlockCommissions(periodId) {
    try {
        const res = await apiRequest(`/settlement-periods/${periodId}/unlock-commissions`, { method: 'POST' });
        const unlockedUsers = res && typeof res.unlocked_users !== 'undefined' ? Number(res.unlocked_users || 0) : 0;
        const unlockedCoins = res && typeof res.unlocked_total_coins !== 'undefined' ? Number(res.unlocked_total_coins || 0) : 0;
        showToast(`å·²æ‰§è¡Œè§£é”ï¼š${unlockedUsers} äººï¼Œ${unlockedCoins} coins`, 'success');
    } catch (error) {
        showToast(error.message || 'è§£é”å¤±è´¥', 'error');
    }
}

async function activatePeriod(periodId) {
    try {
        await apiRequest(`/settlement-periods/${periodId}/activate`, { method: 'POST' });
        showToast('å·²åº”ç”¨ä¸ºå½“å‰ç”Ÿæ•ˆæœŸ', 'success');
        await loadPeriods();
    } catch (error) {
        showToast(error.message || 'è®¾ç½®å¤±è´¥', 'error');
    }
}

async function deletePeriod(periodId, periodLabel) {
    const promptText = [
        'âš ï¸ å±é™©æ“ä½œæ£€æµ‹ï¼',
        'æ“ä½œç±»å‹ï¼šåˆ é™¤ç»“ç®—æœŸ',
        `å½±å“èŒƒå›´ï¼šå°†åˆ é™¤è¯¥ç»“ç®—æœŸåŠå…¶å…³è”çš„å¿«ç…§/æ±‡æ€»/åº”ç¼´/åˆ†æˆæ•°æ®ï¼ˆä»…åœ¨æ— ç¼´è´¹è®°å½•æ—¶å…è®¸ï¼‰`,
        'é£é™©è¯„ä¼°ï¼šåˆ é™¤åæ— æ³•æ¢å¤ï¼Œå¯èƒ½å½±å“å¯¹è´¦ä¸å®¡è®¡',
        '',
        `è¯·åœ¨ä¸‹æ–¹è¾“å…¥â€œç¡®è®¤â€ç»§ç»­ï¼ˆç»“ç®—æœŸï¼š${periodLabel}ï¼ŒID=${periodId}ï¼‰ï¼š`,
    ].join('\n');
    const input = prompt(promptText);
    if (input !== 'ç¡®è®¤') return;

    try {
        await apiRequest(`/settlement-periods/${periodId}`, { method: 'DELETE' });
        showToast('ç»“ç®—æœŸå·²åˆ é™¤', 'success');
        await loadPeriods();
        await loadPayments();
    } catch (error) {
        showToast(error.message || 'åˆ é™¤å¤±è´¥', 'error');
    }
}

async function loadPayments() {
    const body = document.getElementById('paymentAuditTableBody');
    const periodId = document.getElementById('paymentPeriodFilter').value;
    const statusVal = document.getElementById('paymentStatusFilter').value;

    body.innerHTML = '<tr><td colspan="10" class="loading-cell">åŠ è½½ä¸­...</td></tr>';

    const params = new URLSearchParams();
    if (periodId) params.set('period_id', periodId);
    if (statusVal !== '') params.set('status', statusVal);

    try {
        const url = params.toString() ? `/settlement-payments?${params.toString()}` : '/settlement-payments';
        const payments = await apiRequest(url);
        if (!Array.isArray(payments) || payments.length === 0) {
            body.innerHTML = '<tr><td colspan="10" class="empty-cell">æš‚æ— è®°å½•</td></tr>';
            return;
        }

        body.innerHTML = payments.map(p => {
            const st = paymentStatusLabel(p.status);
            const submittedAt = p.submitted_at ? new Date(p.submitted_at).toLocaleString('zh-CN') : '-';
            const confirmedAt = p.confirmed_at ? new Date(p.confirmed_at).toLocaleString('zh-CN') : '-';
            const proof = p.proof_url ? `<a href="${p.proof_url}" target="_blank">æŸ¥çœ‹</a>` : '-';
            const action = Number(p.status) === 0
                ? `
                    <button class="btn btn-primary btn-sm" onclick="confirmPayment(${p.payment_id})">ç¡®è®¤</button>
                    <button class="btn btn-secondary btn-sm" onclick="rejectPayment(${p.payment_id})">é©³å›</button>
                  `
                : '<span style="color:#94a3b8;font-size:12px;">å·²å¤„ç†</span>';
            return `
                <tr>
                    <td class="col-id">${p.payment_id}</td>
                    <td class="col-period-id">${p.period_id}</td>
                    <td class="col-user">${p.payer_user_id}</td>
                    <td class="col-amount">${p.amount_coins.toLocaleString()} <span style="font-size:11px;color:#94a3b8;">coins</span></td>
                    <td>${p.method || '-'}</td>
                    <td style="text-align:center;">${proof}</td>
                    <td style="font-size:12px;color:#64748b;">${submittedAt}</td>
                    <td>${formatStatusBadge(st.type, st.text)}</td>
                    <td style="font-size:12px;color:#64748b;">${confirmedAt}</td>
                    <td class="action-cell">${action}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        body.innerHTML = `<tr><td colspan="10" class="error-cell">${error.message || 'åŠ è½½å¤±è´¥'}</td></tr>`;
    }
}

async function confirmPayment(paymentId) {
    const ok = confirm('ç¡®è®¤è¯¥ç¼´è´¹è®°å½•ï¼Ÿç¡®è®¤åå°†è®¡å…¥å·²ç¼´å¹¶æ›´æ–°çŠ¶æ€ã€‚');
    if (!ok) return;
    try {
        await apiRequest(`/settlement-payments/${paymentId}/confirm`, { method: 'POST' });
        showToast('å·²ç¡®è®¤', 'success');
        await loadPayments();
    } catch (error) {
        showToast(error.message || 'æ“ä½œå¤±è´¥', 'error');
    }
}

async function rejectPayment(paymentId) {
    const reason = prompt('è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰ï¼š');
    if (!reason || !reason.trim()) return;
    try {
        await apiRequest(`/settlement-payments/${paymentId}/reject`, {
            method: 'POST',
            body: JSON.stringify({ reject_reason: reason.trim() })
        });
        showToast('å·²é©³å›', 'success');
        await loadPayments();
    } catch (error) {
        showToast(error.message || 'æ“ä½œå¤±è´¥', 'error');
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    await loadPeriods();
    await loadPayments();
});
</script>
{% endblock %}
