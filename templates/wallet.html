{% extends "base.html" %}

{% block title %}我的钱包 - 快手账号管理平台{% endblock %}

{% block page_title %}我的钱包{% endblock %}

{% block content %}
<div class="data-card">
    <div class="card-header">
        <h3>钱包总览</h3>
        <div class="filter-group" style="display:flex; gap:8px;">
            <button class="btn btn-secondary btn-sm" onclick="refreshWallet()">刷新</button>
            <a class="btn btn-primary btn-sm" href="/settlement-center">结算中心</a>
        </div>
    </div>

    <div class="text-muted" id="walletMeta">加载中...</div>

    <div class="stats-overview" style="margin-top: 12px;">
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletAvailableYuan">¥0.00</span>
                <span class="stat-label">可提现余额</span>
                <span class="text-muted" id="walletAvailableCoins">0 coins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletLockedYuan">¥0.00</span>
                <span class="stat-label">锁定中</span>
                <span class="text-muted" id="walletLockedCoins">0 coins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletRemainingDueYuan">¥0.00</span>
                <span class="stat-label">本期应缴剩余</span>
                <span class="text-muted" id="walletRemainingDueCoins">0 coins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletCommissionExpectedYuan">¥0.00</span>
                <span class="stat-label">本期预计分成</span>
                <span class="text-muted" id="walletCommissionExpectedCoins">0 coins</span>
            </div>
        </div>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>本期结算进度</h3>
    </div>
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletMyPayableStatusText">-</span>
                <span class="stat-label">我的缴费状态</span>
                <span id="walletMyPayableStatusBadge">-</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletL1DueYuan">¥0.00</span>
                <span class="stat-label">一级下级待缴</span>
                <span class="text-muted" id="walletL1DueMeta">0 人 · 0 coins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletL2DueYuan">¥0.00</span>
                <span class="stat-label">二级下级待缴</span>
                <span class="text-muted" id="walletL2DueMeta">0 人 · 0 coins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-value" id="walletPayEndText">-</span>
                <span class="stat-label">缴费截止</span>
                <span class="text-muted" id="walletPayWindowText">-</span>
            </div>
        </div>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>提现申请</h3>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>金额（元）<span class="required">*</span></label>
            <input type="number" id="withdrawAmountYuan" min="0" step="0.01" placeholder="例如 10.00">
            <div class="text-muted" id="withdrawAmountHint">-</div>
        </div>
        <div class="form-group">
            <label>方式</label>
            <select id="withdrawMethod">
                <option value="manual">manual</option>
                <option value="alipay">alipay</option>
                <option value="wechat">wechat</option>
                <option value="bank">bank</option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group" style="flex: 1;">
            <label>收款信息</label>
            <textarea id="withdrawAccountInfo" rows="2" placeholder="例如：支付宝账号/微信号/银行卡信息（建议脱敏）"></textarea>
        </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-primary" onclick="submitWithdrawRequest()">提交提现申请</button>
        <span class="text-muted" id="withdrawAvailableHint">可提现：-</span>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>提现记录</h3>
        <div class="filter-group">
            <button class="btn btn-secondary btn-sm" onclick="loadWithdrawRequests()">刷新</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>金额</th>
                    <th>方式</th>
                    <th>状态</th>
                    <th>申请时间</th>
                    <th>处理时间</th>
                    <th>原因</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="withdrawRequestsTableBody">
                <tr><td colspan="8" class="loading-cell">加载中...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>账本流水</h3>
        <div class="filter-group">
            <button class="btn btn-secondary btn-sm" onclick="loadLedger()">刷新</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>时间</th>
                    <th>类型</th>
                    <th>可用变动</th>
                    <th>锁定变动</th>
                    <th>来源下级</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody id="walletLedgerTableBody">
                <tr><td colspan="6" class="loading-cell">加载中...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let walletSummaryCache = null;

function coinsToYuan(coins, coinRate) {
    const rate = coinRate && coinRate > 0 ? coinRate : 10000;
    return (Number(coins || 0) / rate).toFixed(2);
}

function formatStatusBadge(type, text) {
    return `<span class="status-badge status-${type}">${text}</span>`;
}

function escapeHtml(value) {
    const s = String(value ?? '');
    return s.replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    }[ch]));
}

function payableStatusLabel(status) {
    const s = Number(status);
    if (s === 2) return { type: 'paid', text: '已缴清' };
    if (s === 3) return { type: 'invalid', text: '逾期未缴清' };
    if (s === 1) return { type: 'pending', text: '部分已缴' };
    return { type: 'pending', text: '未缴' };
}

function entryTypeLabel(type) {
    const map = {
        'COMMISSION_LOCKED_IN': '分成入账（锁定）',
        'COMMISSION_UNLOCK': '分成解锁',
        'WITHDRAW_APPLY': '提现申请',
        'WITHDRAW_PAID': '提现打款',
        'WITHDRAW_OUT': '提现出账',
        'WITHDRAW_REFUND': '提现退回',
        'ADJUST': '人工调整'
    };
    return map[type] || type;
}

function withdrawStatusLabel(status) {
    const s = Number(status);
    if (s === 2) return { type: 'paid', text: '已打款' };
    if (s === 3) return { type: 'invalid', text: '已驳回' };
    if (s === 4) return { type: 'closed', text: '已取消' };
    if (s === 1) return { type: 'pending', text: '已通过' };
    return { type: 'pending', text: '待审核' };
}

function getCoinRate() {
    const rate = walletSummaryCache ? Number(walletSummaryCache.coin_rate || 0) : 0;
    return rate && rate > 0 ? rate : 10000;
}

function updateWithdrawHints() {
    const coinRate = getCoinRate();
    const input = document.getElementById('withdrawAmountYuan');
    const hint = document.getElementById('withdrawAmountHint');

    const amountYuan = input ? String(input.value || '').trim() : '';
    if (!amountYuan) {
        if (hint) hint.textContent = `兑率：${coinRate} coins = 1 元`;
        return;
    }

    const yuan = Number(amountYuan);
    if (!Number.isFinite(yuan) || yuan <= 0) {
        if (hint) hint.textContent = '请输入正确的金额（>0）';
        return;
    }

    const coins = Math.round(yuan * coinRate);
    if (hint) hint.textContent = `约 ${coins} coins（兑率：${coinRate}）`;
}

async function loadWalletSummary() {
    try {
        const data = await apiRequest('/wallet/summary');
        walletSummaryCache = data;

        const coinRate = Number(data.coin_rate || 10000);
        const period = data.period || null;
        const wallet = data.wallet || null;

        const availableCoins = wallet ? Number(wallet.available_coins || 0) : 0;
        const lockedCoins = wallet ? Number(wallet.locked_coins || 0) : 0;
        const remainingDueCoins = Number(data.my_remaining_due_coins || 0);
        const commissionExpectedCoins = Number(data.commission_expected_coins || 0);

        document.getElementById('walletAvailableCoins').textContent = `${availableCoins} coins`;
        document.getElementById('walletAvailableYuan').textContent = `¥${coinsToYuan(availableCoins, coinRate)}`;
        const withdrawAvailableHint = document.getElementById('withdrawAvailableHint');
        if (withdrawAvailableHint) {
            withdrawAvailableHint.textContent = `可提现：¥${coinsToYuan(availableCoins, coinRate)}（${availableCoins} coins）`;
        }

        document.getElementById('walletLockedCoins').textContent = `${lockedCoins} coins`;
        document.getElementById('walletLockedYuan').textContent = `¥${coinsToYuan(lockedCoins, coinRate)}`;

        document.getElementById('walletRemainingDueCoins').textContent = `${remainingDueCoins} coins`;
        document.getElementById('walletRemainingDueYuan').textContent = `¥${coinsToYuan(remainingDueCoins, coinRate)}`;

        document.getElementById('walletCommissionExpectedCoins').textContent = `${commissionExpectedCoins} coins`;
        document.getElementById('walletCommissionExpectedYuan').textContent = `¥${coinsToYuan(commissionExpectedCoins, coinRate)}`;

        const metaParts = [`兑率：${coinRate} coins = 1 元`];
        if (period) {
            metaParts.push(`本期：${period.period_start} ~ ${period.period_end}（period_id=${period.period_id}）`);
        } else {
            metaParts.push('当前暂无结算期');
        }
        document.getElementById('walletMeta').textContent = metaParts.join(' · ');

        const payable = data.my_payable || null;
        const st = payableStatusLabel(payable ? payable.status : 0);
        document.getElementById('walletMyPayableStatusText').textContent = st.text;
        document.getElementById('walletMyPayableStatusBadge').innerHTML = formatStatusBadge(st.type, st.text);

        const l1 = data.l1_due || { cnt: 0, sum_due_coins: 0 };
        const l2 = data.l2_due || { cnt: 0, sum_due_coins: 0 };

        const l1Coins = Number(l1.sum_due_coins || 0);
        const l2Coins = Number(l2.sum_due_coins || 0);

        document.getElementById('walletL1DueYuan').textContent = `¥${coinsToYuan(l1Coins, coinRate)}`;
        document.getElementById('walletL1DueMeta').textContent = `${Number(l1.cnt || 0)} 人 · ${l1Coins} coins`;

        document.getElementById('walletL2DueYuan').textContent = `¥${coinsToYuan(l2Coins, coinRate)}`;
        document.getElementById('walletL2DueMeta').textContent = `${Number(l2.cnt || 0)} 人 · ${l2Coins} coins`;

        if (period) {
            document.getElementById('walletPayEndText').textContent = period.pay_end || '-';
            document.getElementById('walletPayWindowText').textContent = `${period.pay_start} ~ ${period.pay_end}`;
        } else {
            document.getElementById('walletPayEndText').textContent = '-';
            document.getElementById('walletPayWindowText').textContent = '-';
        }

        updateWithdrawHints();
    } catch (error) {
        console.error('加载钱包汇总失败:', error);
        document.getElementById('walletMeta').textContent = error.message || '加载失败';
    }
}

async function loadLedger() {
    const tbody = document.getElementById('walletLedgerTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">加载中...</td></tr>';

    try {
        const rows = await apiRequest('/wallet/ledger?limit=100');
        if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">暂无记录</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const da = Number(r.delta_available_coins || 0);
            const dl = Number(r.delta_locked_coins || 0);

            const daText = da === 0 ? '-' : `${da > 0 ? '+' : ''}${da}`;
            const dlText = dl === 0 ? '-' : `${dl > 0 ? '+' : ''}${dl}`;

            const daClass = da > 0 ? 'amount-positive' : (da < 0 ? 'amount-negative' : '');
            const dlClass = dl > 0 ? 'amount-positive' : (dl < 0 ? 'amount-negative' : '');

            return `
                <tr>
                    <td>${new Date(r.created_at).toLocaleString('zh-CN')}</td>
                    <td>${entryTypeLabel(r.entry_type)}</td>
                    <td class="${daClass}">${daText}</td>
                    <td class="${dlClass}">${dlText}</td>
                    <td>${r.ref_source_user_id ? r.ref_source_user_id : '-'}</td>
                    <td>${r.remark || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="6" class="error-cell">${error.message || '加载失败'}</td></tr>`;
    }
}

async function submitWithdrawRequest() {
    const input = document.getElementById('withdrawAmountYuan');
    const amountYuan = input ? String(input.value || '').trim() : '';
    if (!amountYuan) {
        showToast('请输入提现金额', 'error');
        return;
    }

    const yuan = Number(amountYuan);
    if (!Number.isFinite(yuan) || yuan <= 0) {
        showToast('请输入正确的提现金额（>0）', 'error');
        return;
    }

    const coinRate = getCoinRate();
    const amountCoins = Math.round(yuan * coinRate);
    if (!Number.isFinite(amountCoins) || amountCoins <= 0) {
        showToast('换算后金额无效', 'error');
        return;
    }

    const method = String(document.getElementById('withdrawMethod').value || 'manual');
    const accountInfo = String(document.getElementById('withdrawAccountInfo').value || '').trim();

    try {
        await apiRequest('/withdraw-requests', {
            method: 'POST',
            body: JSON.stringify({
                amount_coins: amountCoins,
                method: method,
                account_info: accountInfo ? accountInfo : null
            })
        });
        showToast('提现申请已提交', 'success');
        if (input) input.value = '';
        document.getElementById('withdrawAccountInfo').value = '';
        updateWithdrawHints();
        refreshWallet();
    } catch (error) {
        showToast(error.message || '提交失败', 'error');
    }
}

async function cancelWithdrawRequest(withdrawId) {
    const ok = confirm('确认取消提现吗？取消将回滚可用余额。');
    if (!ok) return;

    try {
        await apiRequest(`/withdraw-requests/${withdrawId}/cancel`, { method: 'POST' });
        showToast('已取消并回滚余额', 'success');
        refreshWallet();
    } catch (error) {
        showToast(error.message || '取消失败', 'error');
    }
}

async function loadWithdrawRequests() {
    const tbody = document.getElementById('withdrawRequestsTableBody');
    tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">加载中...</td></tr>';

    try {
        const rows = await apiRequest('/withdraw-requests/my?limit=50');
        const coinRate = getCoinRate();
        if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">暂无记录</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const st = withdrawStatusLabel(r.status);
            const amountCoins = Number(r.amount_coins || 0);
            const amountText = `¥${coinsToYuan(amountCoins, coinRate)}（${amountCoins} coins）`;
            const methodText = escapeHtml(r.method || '-');
            const reasonText = escapeHtml(r.reject_reason || '-');
            const actions = Number(r.status || 0) === 0
                ? `<button class="btn btn-danger btn-sm" onclick="cancelWithdrawRequest(${r.withdraw_id})">取消</button>`
                : '-';

            return `
                <tr>
                    <td>${r.withdraw_id}</td>
                    <td>${amountText}</td>
                    <td>${methodText}</td>
                    <td>${formatStatusBadge(st.type, st.text)}</td>
                    <td>${r.requested_at ? new Date(r.requested_at).toLocaleString('zh-CN') : '-'}</td>
                    <td>${r.processed_at ? new Date(r.processed_at).toLocaleString('zh-CN') : '-'}</td>
                    <td style="max-width:220px; white-space:normal;">${reasonText}</td>
                    <td class="action-cell">${actions}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="8" class="error-cell">${error.message || '加载失败'}</td></tr>`;
    }
}

function refreshWallet() {
    loadWalletSummary();
    loadWithdrawRequests();
    loadLedger();
}

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('withdrawAmountYuan');
    if (input) {
        input.addEventListener('input', updateWithdrawHints);
    }
    refreshWallet();
});
</script>
{% endblock %}
