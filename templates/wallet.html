{% extends "base.html" %}

{% block title %}æˆ‘çš„é’±åŒ… - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}æˆ‘çš„é’±åŒ…{% endblock %}

{% block content %}
<!-- é’±åŒ…æ€»è§ˆå¤´éƒ¨ -->
<div class="wallet-header-card">
    <div class="wallet-header-info">
        <div class="wallet-header-title">
            <span class="wallet-icon">ğŸ‘›</span>
            <div>
                <h3>æˆ‘çš„é’±åŒ…</h3>
                <p class="wallet-subtitle">èµ„é‡‘ç®¡ç†ä¸æç°</p>
            </div>
        </div>
        <div class="wallet-actions">
            <button class="btn-wallet-action" onclick="refreshWallet()">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
            <a class="btn-wallet-action btn-primary" href="/settlement-center">
                <span>ğŸ“Š</span> ç»“ç®—ä¸­å¿ƒ
            </a>
        </div>
    </div>
    <div class="wallet-meta-info" id="walletMeta">åŠ è½½ä¸­...</div>
</div>

<!-- é’±åŒ…ä½™é¢å¡ç‰‡ -->
<div class="wallet-balance-grid">
    <div class="wallet-balance-card wallet-available">
        <div class="balance-icon">ğŸ’µ</div>
        <div class="balance-content">
            <span class="balance-value" id="walletAvailableYuan">Â¥0.00</span>
            <span class="balance-label">å¯æç°ä½™é¢</span>
            <span class="balance-coins" id="walletAvailableCoins">0 coins</span>
        </div>
        <div class="balance-bg-icon">ğŸ’µ</div>
    </div>
    <div class="wallet-balance-card wallet-locked">
        <div class="balance-icon">ğŸ”’</div>
        <div class="balance-content">
            <span class="balance-value" id="walletLockedYuan">Â¥0.00</span>
            <span class="balance-label">é”å®šä¸­</span>
            <span class="balance-coins" id="walletLockedCoins">0 coins</span>
        </div>
        <div class="balance-bg-icon">ğŸ”’</div>
    </div>
    <div class="wallet-balance-card wallet-due">
        <div class="balance-icon">ğŸ“¤</div>
        <div class="balance-content">
            <span class="balance-value" id="walletRemainingDueYuan">Â¥0.00</span>
            <span class="balance-label">æœ¬æœŸåº”ç¼´å‰©ä½™</span>
            <span class="balance-coins" id="walletRemainingDueCoins">0 coins</span>
        </div>
        <div class="balance-bg-icon">ğŸ“¤</div>
    </div>
    <div class="wallet-balance-card wallet-commission">
        <div class="balance-icon">ğŸ“ˆ</div>
        <div class="balance-content">
            <span class="balance-value" id="walletCommissionExpectedYuan">Â¥0.00</span>
            <span class="balance-label">æœ¬æœŸé¢„è®¡åˆ†æˆ</span>
            <span class="balance-coins" id="walletCommissionExpectedCoins">0 coins</span>
        </div>
        <div class="balance-bg-icon">ğŸ“ˆ</div>
    </div>
</div>

<!-- ç»“ç®—è¿›åº¦å¡ç‰‡ -->
<div class="wallet-section-card">
    <div class="wallet-section-header">
        <h3>ğŸ“Š æœ¬æœŸç»“ç®—è¿›åº¦</h3>
    </div>
    <div class="wallet-progress-grid">
        <div class="progress-item">
            <span class="progress-label">æˆ‘çš„ç¼´è´¹çŠ¶æ€</span>
            <span class="progress-value" id="walletMyPayableStatusText">-</span>
            <span class="progress-badge" id="walletMyPayableStatusBadge">-</span>
        </div>
        <div class="progress-item">
            <span class="progress-label">ä¸€çº§ä¸‹çº§å¾…ç¼´</span>
            <span class="progress-value" id="walletL1DueYuan">Â¥0.00</span>
            <span class="progress-meta" id="walletL1DueMeta">0 äºº Â· 0 coins</span>
        </div>
        <div class="progress-item">
            <span class="progress-label">äºŒçº§ä¸‹çº§å¾…ç¼´</span>
            <span class="progress-value" id="walletL2DueYuan">Â¥0.00</span>
            <span class="progress-meta" id="walletL2DueMeta">0 äºº Â· 0 coins</span>
        </div>
        <div class="progress-item">
            <span class="progress-label">ç¼´è´¹æˆªæ­¢</span>
            <span class="progress-value" id="walletPayEndText">-</span>
            <span class="progress-meta" id="walletPayWindowText">-</span>
        </div>
    </div>
</div>

<!-- æç°ç”³è¯·è¡¨å• -->
<div class="wallet-section-card">
    <div class="wallet-section-header">
        <h3>ğŸ’³ æç°ç”³è¯·</h3>
    </div>
    <div class="withdraw-form-body">
        <div class="withdraw-form-grid">
            <div class="withdraw-form-group">
                <label>é‡‘é¢ï¼ˆå…ƒï¼‰<span class="required">*</span></label>
                <div class="input-with-hint">
                    <input type="number" id="withdrawAmountYuan" min="0" step="0.01" placeholder="ä¾‹å¦‚ 10.00">
                    <span class="input-suffix">Â¥</span>
                </div>
                <span class="input-hint" id="withdrawAmountHint">-</span>
            </div>
            <div class="withdraw-form-group">
                <label>æç°æ–¹å¼</label>
                <select id="withdrawMethod">
                    <option value="manual">ğŸ”„ äººå·¥è½¬è´¦</option>
                    <option value="alipay">ğŸ’™ æ”¯ä»˜å®</option>
                    <option value="wechat">ğŸ’š å¾®ä¿¡æ”¯ä»˜</option>
                    <option value="bank">ğŸ¦ é“¶è¡Œå¡</option>
                </select>
            </div>
        </div>
        <div class="withdraw-form-group">
            <label>æ”¶æ¬¾ä¿¡æ¯</label>
            <textarea id="withdrawAccountInfo" rows="2" placeholder="ä¾‹å¦‚ï¼šæ”¯ä»˜å®è´¦å·/å¾®ä¿¡å·/é“¶è¡Œå¡ä¿¡æ¯ï¼ˆå»ºè®®è„±æ•ï¼‰"></textarea>
            <span class="input-hint">å»ºè®®å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†</span>
        </div>
        <div class="withdraw-submit-row">
            <button class="btn-withdraw" onclick="submitWithdrawRequest()">æäº¤æç°ç”³è¯·</button>
            <span class="withdraw-available" id="withdrawAvailableHint">å¯æç°ï¼š-</span>
        </div>
    </div>
</div>

<!-- æç°è®°å½• -->
<div class="wallet-section-card">
    <div class="wallet-section-header">
        <h3>ğŸ“œ æç°è®°å½•</h3>
        <button class="btn-sm-refresh" onclick="loadWithdrawRequests()">åˆ·æ–°</button>
    </div>
    <div class="table-responsive">
        <table class="wallet-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>é‡‘é¢</th>
                    <th>æ–¹å¼</th>
                    <th>çŠ¶æ€</th>
                    <th>ç”³è¯·æ—¶é—´</th>
                    <th>å¤„ç†æ—¶é—´</th>
                    <th>åŸå› </th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="withdrawRequestsTableBody">
                <tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- è´¦æœ¬æµæ°´ -->
<div class="wallet-section-card">
    <div class="wallet-section-header">
        <h3>ğŸ“’ è´¦æœ¬æµæ°´</h3>
        <button class="btn-sm-refresh" onclick="loadLedger()">åˆ·æ–°</button>
    </div>
    <div class="table-responsive">
        <table class="wallet-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>å¯ç”¨å˜åŠ¨</th>
                    <th>é”å®šå˜åŠ¨</th>
                    <th>æ¥æºä¸‹çº§</th>
                    <th>å¤‡æ³¨</th>
                </tr>
            </thead>
            <tbody id="walletLedgerTableBody">
                <tr><td colspan="6" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
/* é’±åŒ…å¤´éƒ¨å¡ç‰‡ */
.wallet-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
}

.wallet-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.wallet-header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.wallet-icon {
    font-size: 48px;
    background: rgba(255,255,255,0.2);
    width: 72px;
    height: 72px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wallet-header-title h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: white;
}

.wallet-subtitle {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: rgba(255,255,255,0.8);
}

.wallet-actions {
    display: flex;
    gap: 12px;
}

.btn-wallet-action {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    transition: all 0.2s;
}

.btn-wallet-action:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
}

.btn-wallet-action.btn-primary {
    background: white;
    color: #667eea;
    border-color: white;
}

.wallet-meta-info {
    color: rgba(255,255,255,0.9);
    font-size: 13px;
}

/* ä½™é¢å¡ç‰‡ç½‘æ ¼ */
.wallet-balance-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}

.wallet-balance-card {
    background: var(--bg-color);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
}

.wallet-balance-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.wallet-available::before {
    background: linear-gradient(90deg, #10b981, #34d399);
}

.wallet-locked::before {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
}

.wallet-due::before {
    background: linear-gradient(90deg, #ef4444, #f87171);
}

.wallet-commission::before {
    background: linear-gradient(90deg, #8b5cf6, #a78bfa);
}

.wallet-balance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.balance-icon {
    font-size: 32px;
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    z-index: 1;
}

.wallet-available .balance-icon {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
}

.wallet-locked .balance-icon {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.wallet-due .balance-icon {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
}

.wallet-commission .balance-icon {
    background: linear-gradient(135deg, #ede9fe, #ddd6fe);
}

.balance-content {
    display: flex;
    flex-direction: column;
    z-index: 1;
}

.balance-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-color);
    line-height: 1.2;
}

.balance-label {
    font-size: 13px;
    color: var(--text-muted);
    margin: 4px 0;
}

.balance-coins {
    font-size: 12px;
    color: var(--text-muted);
}

.balance-bg-icon {
    position: absolute;
    right: -8px;
    bottom: -8px;
    font-size: 80px;
    opacity: 0.05;
}

/* åŒºå—å¡ç‰‡ */
.wallet-section-card {
    background: var(--bg-color);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    overflow: hidden;
}

.wallet-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.wallet-section-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.btn-sm-refresh {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-muted);
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
}

.btn-sm-refresh:hover {
    border-color: #667eea;
    color: #667eea;
}

/* è¿›åº¦ç½‘æ ¼ */
.wallet-progress-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    padding: 20px 24px;
}

.progress-item {
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: rgba(0,0,0,0.02);
    border-radius: 12px;
}

.progress-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.progress-value {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 4px;
}

.progress-badge {
    font-size: 12px;
}

.progress-meta {
    font-size: 12px;
    color: var(--text-muted);
}

/* æç°è¡¨å• */
.withdraw-form-body {
    padding: 24px;
}

.withdraw-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.withdraw-form-group {
    display: flex;
    flex-direction: column;
}

.withdraw-form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
}

.withdraw-form-group .required {
    color: #ef4444;
}

.input-with-hint {
    position: relative;
}

.input-with-hint input {
    width: 100%;
    padding: 12px 16px;
    padding-right: 40px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 14px;
    background: var(--bg-color);
    transition: all 0.2s;
}

.input-with-hint input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-suffix {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-weight: 500;
}

.withdraw-form-group select,
.withdraw-form-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 14px;
    background: var(--bg-color);
    transition: all 0.2s;
    resize: vertical;
}

.withdraw-form-group select:focus,
.withdraw-form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
}

.withdraw-submit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-withdraw {
    background: linear-gradient(135deg, #10b981, #34d399);
    border: none;
    color: white;
    padding: 12px 28px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-withdraw:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.withdraw-available {
    font-size: 14px;
    color: var(--text-muted);
}

/* è¡¨æ ¼æ ·å¼ */
.wallet-table {
    width: 100%;
    border-collapse: collapse;
}

.wallet-table thead th {
    text-align: left;
    padding: 14px 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.wallet-table tbody td {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.wallet-table tbody tr:last-child td {
    border-bottom: none;
}

.wallet-table tbody tr:hover {
    background: rgba(0,0,0,0.02);
}

.amount-positive {
    color: #10b981;
    font-weight: 500;
}

.amount-negative {
    color: #ef4444;
    font-weight: 500;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.status-paid {
    background: #d1fae5;
    color: #065f46;
}

.status-invalid, .status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.status-open {
    background: #dbeafe;
    color: #1e40af;
}

.status-closed {
    background: #e5e7eb;
    color: #374151;
}

.loading-cell, .empty-cell, .error-cell {
    text-align: center !important;
    padding: 40px 20px !important;
    color: var(--text-muted);
}

/* å“åº”å¼é€‚é… */
@media (max-width: 1200px) {
    .wallet-balance-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .wallet-progress-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .wallet-header-info {
        flex-direction: column;
        gap: 16px;
    }

    .wallet-header-title {
        flex-direction: column;
        text-align: center;
    }

    .wallet-actions {
        width: 100%;
        justify-content: center;
    }

    .wallet-balance-grid {
        grid-template-columns: 1fr;
    }

    .wallet-progress-grid {
        grid-template-columns: 1fr;
    }

    .withdraw-form-grid {
        grid-template-columns: 1fr;
    }

    .withdraw-submit-row {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }

    .btn-withdraw {
        width: 100%;
    }

    .wallet-table {
        font-size: 12px;
    }

    .wallet-table thead th,
    .wallet-table tbody td {
        padding: 10px 12px;
    }
}
</style>

<script>
let walletSummaryCache = null;

function coinsToYuan(coins, coinRate) {
    const rate = coinRate && coinRate > 0 ? coinRate : 10000;
    return (Number(coins || 0) / rate).toFixed(2);
}

function formatStatusBadge(type, text) {
    return `<span class="status-badge status-${type}">${text}</span>`;
}

function escapeHtml(value) {
    const s = String(value ?? '');
    return s.replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    }[ch]));
}

function payableStatusLabel(status) {
    const s = Number(status);
    if (s === 2) return { type: 'paid', text: 'å·²ç¼´æ¸…' };
    if (s === 3) return { type: 'invalid', text: 'é€¾æœŸæœªç¼´æ¸…' };
    if (s === 1) return { type: 'pending', text: 'éƒ¨åˆ†å·²ç¼´' };
    return { type: 'pending', text: 'æœªç¼´' };
}

function entryTypeLabel(type) {
    const map = {
        'COMMISSION_LOCKED_IN': 'åˆ†æˆå…¥è´¦ï¼ˆé”å®šï¼‰',
        'COMMISSION_UNLOCK': 'åˆ†æˆè§£é”',
        'WITHDRAW_APPLY': 'æç°ç”³è¯·',
        'WITHDRAW_PAID': 'æç°æ‰“æ¬¾',
        'WITHDRAW_OUT': 'æç°å‡ºè´¦',
        'WITHDRAW_REFUND': 'æç°é€€å›',
        'ADJUST': 'äººå·¥è°ƒæ•´'
    };
    return map[type] || type;
}

function withdrawStatusLabel(status) {
    const s = Number(status);
    if (s === 2) return { type: 'paid', text: 'å·²æ‰“æ¬¾' };
    if (s === 3) return { type: 'invalid', text: 'å·²é©³å›' };
    if (s === 4) return { type: 'closed', text: 'å·²å–æ¶ˆ' };
    if (s === 1) return { type: 'pending', text: 'å·²é€šè¿‡' };
    return { type: 'pending', text: 'å¾…å®¡æ ¸' };
}

function getCoinRate() {
    const rate = walletSummaryCache ? Number(walletSummaryCache.coin_rate || 0) : 0;
    return rate && rate > 0 ? rate : 10000;
}

function updateWithdrawHints() {
    const coinRate = getCoinRate();
    const input = document.getElementById('withdrawAmountYuan');
    const hint = document.getElementById('withdrawAmountHint');

    const amountYuan = input ? String(input.value || '').trim() : '';
    if (!amountYuan) {
        if (hint) hint.textContent = `å…‘ç‡ï¼š${coinRate} coins = 1 å…ƒ`;
        return;
    }

    const yuan = Number(amountYuan);
    if (!Number.isFinite(yuan) || yuan <= 0) {
        if (hint) hint.textContent = 'è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢ï¼ˆ>0ï¼‰';
        return;
    }

    const coins = Math.round(yuan * coinRate);
    if (hint) hint.textContent = `çº¦ ${coins} coinsï¼ˆå…‘ç‡ï¼š${coinRate}ï¼‰`;
}

async function loadWalletSummary() {
    try {
        const data = await apiRequest('/wallet/summary');
        walletSummaryCache = data;

        const coinRate = Number(data.coin_rate || 10000);
        const period = data.period || null;
        const wallet = data.wallet || null;

        const availableCoins = wallet ? Number(wallet.available_coins || 0) : 0;
        const lockedCoins = wallet ? Number(wallet.locked_coins || 0) : 0;
        const remainingDueCoins = Number(data.my_remaining_due_coins || 0);
        const commissionExpectedCoins = Number(data.commission_expected_coins || 0);

        document.getElementById('walletAvailableCoins').textContent = `${availableCoins} coins`;
        document.getElementById('walletAvailableYuan').textContent = `Â¥${coinsToYuan(availableCoins, coinRate)}`;
        const withdrawAvailableHint = document.getElementById('withdrawAvailableHint');
        if (withdrawAvailableHint) {
            withdrawAvailableHint.textContent = `å¯æç°ï¼šÂ¥${coinsToYuan(availableCoins, coinRate)}ï¼ˆ${availableCoins} coinsï¼‰`;
        }

        document.getElementById('walletLockedCoins').textContent = `${lockedCoins} coins`;
        document.getElementById('walletLockedYuan').textContent = `Â¥${coinsToYuan(lockedCoins, coinRate)}`;

        document.getElementById('walletRemainingDueCoins').textContent = `${remainingDueCoins} coins`;
        document.getElementById('walletRemainingDueYuan').textContent = `Â¥${coinsToYuan(remainingDueCoins, coinRate)}`;

        document.getElementById('walletCommissionExpectedCoins').textContent = `${commissionExpectedCoins} coins`;
        document.getElementById('walletCommissionExpectedYuan').textContent = `Â¥${coinsToYuan(commissionExpectedCoins, coinRate)}`;

        const metaParts = [`ğŸ’± å…‘ç‡ï¼š${coinRate} coins = 1 å…ƒ`];
        if (period) {
            metaParts.push(`ğŸ“… æœ¬æœŸï¼š${period.period_start} ~ ${period.period_end}`);
        } else {
            metaParts.push('å½“å‰æš‚æ— ç»“ç®—æœŸ');
        }
        document.getElementById('walletMeta').textContent = metaParts.join(' Â· ');

        const payable = data.my_payable || null;
        const st = payableStatusLabel(payable ? payable.status : 0);
        document.getElementById('walletMyPayableStatusText').textContent = st.text;
        document.getElementById('walletMyPayableStatusBadge').innerHTML = formatStatusBadge(st.type, st.text);

        const l1 = data.l1_due || { cnt: 0, sum_due_coins: 0 };
        const l2 = data.l2_due || { cnt: 0, sum_due_coins: 0 };

        const l1Coins = Number(l1.sum_due_coins || 0);
        const l2Coins = Number(l2.sum_due_coins || 0);

        document.getElementById('walletL1DueYuan').textContent = `Â¥${coinsToYuan(l1Coins, coinRate)}`;
        document.getElementById('walletL1DueMeta').textContent = `${Number(l1.cnt || 0)} äºº Â· ${l1Coins} coins`;

        document.getElementById('walletL2DueYuan').textContent = `Â¥${coinsToYuan(l2Coins, coinRate)}`;
        document.getElementById('walletL2DueMeta').textContent = `${Number(l2.cnt || 0)} äºº Â· ${l2Coins} coins`;

        if (period) {
            document.getElementById('walletPayEndText').textContent = period.pay_end || '-';
            document.getElementById('walletPayWindowText').textContent = `${period.pay_start} ~ ${period.pay_end}`;
        } else {
            document.getElementById('walletPayEndText').textContent = '-';
            document.getElementById('walletPayWindowText').textContent = '-';
        }

        updateWithdrawHints();
    } catch (error) {
        console.error('åŠ è½½é’±åŒ…æ±‡æ€»å¤±è´¥:', error);
        document.getElementById('walletMeta').textContent = error.message || 'åŠ è½½å¤±è´¥';
    }
}

async function loadLedger() {
    const tbody = document.getElementById('walletLedgerTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">åŠ è½½ä¸­...</td></tr>';

    try {
        const rows = await apiRequest('/wallet/ledger?limit=100');
        if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">æš‚æ— è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const da = Number(r.delta_available_coins || 0);
            const dl = Number(r.delta_locked_coins || 0);

            const daText = da === 0 ? '-' : `${da > 0 ? '+' : ''}${da}`;
            const dlText = dl === 0 ? '-' : `${dl > 0 ? '+' : ''}${dl}`;

            const daClass = da > 0 ? 'amount-positive' : (da < 0 ? 'amount-negative' : '');
            const dlClass = dl > 0 ? 'amount-positive' : (dl < 0 ? 'amount-negative' : '');

            return `
                <tr>
                    <td>${new Date(r.created_at).toLocaleString('zh-CN')}</td>
                    <td>${entryTypeLabel(r.entry_type)}</td>
                    <td class="${daClass}">${daText}</td>
                    <td class="${dlClass}">${dlText}</td>
                    <td>${r.ref_source_user_id ? r.ref_source_user_id : '-'}</td>
                    <td>${r.remark || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="6" class="error-cell">${error.message || 'åŠ è½½å¤±è´¥'}</td></tr>`;
    }
}

async function submitWithdrawRequest() {
    const input = document.getElementById('withdrawAmountYuan');
    const amountYuan = input ? String(input.value || '').trim() : '';
    if (!amountYuan) {
        showToast('è¯·è¾“å…¥æç°é‡‘é¢', 'error');
        return;
    }

    const yuan = Number(amountYuan);
    if (!Number.isFinite(yuan) || yuan <= 0) {
        showToast('è¯·è¾“å…¥æ­£ç¡®çš„æç°é‡‘é¢ï¼ˆ>0ï¼‰', 'error');
        return;
    }

    const coinRate = getCoinRate();
    const amountCoins = Math.round(yuan * coinRate);
    if (!Number.isFinite(amountCoins) || amountCoins <= 0) {
        showToast('æ¢ç®—åé‡‘é¢æ— æ•ˆ', 'error');
        return;
    }

    const method = String(document.getElementById('withdrawMethod').value || 'manual');
    const accountInfo = String(document.getElementById('withdrawAccountInfo').value || '').trim();

    try {
        await apiRequest('/withdraw-requests', {
            method: 'POST',
            body: JSON.stringify({
                amount_coins: amountCoins,
                method: method,
                account_info: accountInfo ? accountInfo : null
            })
        });
        showToast('æç°ç”³è¯·å·²æäº¤', 'success');
        if (input) input.value = '';
        document.getElementById('withdrawAccountInfo').value = '';
        updateWithdrawHints();
        refreshWallet();
    } catch (error) {
        showToast(error.message || 'æäº¤å¤±è´¥', 'error');
    }
}

async function cancelWithdrawRequest(withdrawId) {
    const ok = confirm('ç¡®è®¤å–æ¶ˆæç°å—ï¼Ÿå–æ¶ˆå°†å›æ»šå¯ç”¨ä½™é¢ã€‚');
    if (!ok) return;

    try {
        await apiRequest(`/withdraw-requests/${withdrawId}/cancel`, { method: 'POST' });
        showToast('å·²å–æ¶ˆå¹¶å›æ»šä½™é¢', 'success');
        refreshWallet();
    } catch (error) {
        showToast(error.message || 'å–æ¶ˆå¤±è´¥', 'error');
    }
}

async function loadWithdrawRequests() {
    const tbody = document.getElementById('withdrawRequestsTableBody');
    tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>';

    try {
        const rows = await apiRequest('/withdraw-requests/my?limit=50');
        const coinRate = getCoinRate();
        if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const st = withdrawStatusLabel(r.status);
            const amountCoins = Number(r.amount_coins || 0);
            const amountText = `Â¥${coinsToYuan(amountCoins, coinRate)}ï¼ˆ${amountCoins} coinsï¼‰`;
            const methodText = escapeHtml(r.method || '-');
            const reasonText = escapeHtml(r.reject_reason || '-');
            const actions = Number(r.status || 0) === 0
                ? `<button class="btn btn-danger btn-sm" onclick="cancelWithdrawRequest(${r.withdraw_id})">å–æ¶ˆ</button>`
                : '-';

            return `
                <tr>
                    <td>${r.withdraw_id}</td>
                    <td>${amountText}</td>
                    <td>${methodText}</td>
                    <td>${formatStatusBadge(st.type, st.text)}</td>
                    <td>${r.requested_at ? new Date(r.requested_at).toLocaleString('zh-CN') : '-'}</td>
                    <td>${r.processed_at ? new Date(r.processed_at).toLocaleString('zh-CN') : '-'}</td>
                    <td style="max-width:220px; white-space:normal;">${reasonText}</td>
                    <td class="action-cell">${actions}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="8" class="error-cell">${error.message || 'åŠ è½½å¤±è´¥'}</td></tr>`;
    }
}

function refreshWallet() {
    loadWalletSummary();
    loadWithdrawRequests();
    loadLedger();
}

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('withdrawAmountYuan');
    if (input) {
        input.addEventListener('input', updateWithdrawHints);
    }
    refreshWallet();
});
</script>
{% endblock %}
