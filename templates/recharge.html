{% extends "base.html" %}

{% block title %}å……å€¼ä¸­å¿ƒ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}å……å€¼ä¸­å¿ƒ{% endblock %}

{% block content %}
<div class="page-header">
    <h2>è´¦æˆ·å……å€¼</h2>
    <p>æ‰«æäºŒç»´ç å®Œæˆå……å€¼ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†è´¦</p>
</div>

<div class="recharge-container">
    <!-- å……å€¼è¡¨å• -->
    <div class="recharge-form-card">
        <h3>åˆ›å»ºå……å€¼è®¢å•</h3>
        <form id="rechargeForm">
            <div class="form-group">
                <label>å……å€¼é‡‘é¢ <span class="required">*</span></label>
                <div class="amount-presets">
                    <button type="button" class="amount-preset" data-amount="100">100å…ƒ</button>
                    <button type="button" class="amount-preset" data-amount="500">500å…ƒ</button>
                    <button type="button" class="amount-preset" data-amount="1000">1000å…ƒ</button>
                    <button type="button" class="amount-preset" data-amount="2000">2000å…ƒ</button>
                </div>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01"
                       placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢" required>
                <div class="amount-hint">
                    <span class="hint-icon">ğŸ’¡</span>
                    <span class="hint-text">åˆ†è´¦è¯´æ˜ï¼šå¹³å°æŠ½æˆ10%ï¼Œå‰©ä½™é‡‘é¢æŒ‰æ¨å¹¿å…³ç³»åˆ†é…</span>
                </div>
            </div>

            <div class="form-group">
                <label>ä»˜æ¬¾å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
                <input type="text" id="remarkIn" name="remarkIn" maxlength="200"
                       placeholder="å¯å¡«å†™æ‚¨çš„å¤‡æ³¨ä¿¡æ¯">
            </div>

            <button type="submit" class="btn btn-primary btn-large">
                åˆ›å»ºå……å€¼è®¢å•
            </button>
        </form>

        <!-- å½“å‰ä½™é¢ -->
        <div class="current-balance">
            <span class="balance-label">å½“å‰ä½™é¢ï¼š</span>
            <span class="balance-amount" id="currentBalance">--</span>
        </div>
    </div>

    <!-- æ”¯ä»˜ä¿¡æ¯ -->
    <div class="payment-card" id="paymentCard" style="display: none;">
        <h3>æ‰«ç æ”¯ä»˜</h3>

        <div class="order-info">
            <div class="info-row">
                <span class="info-label">è®¢å•å·ï¼š</span>
                <span class="info-value" id="orderNo">--</span>
                <button class="btn-copy" onclick="RechargePage.copyOrderNo()">å¤åˆ¶</button>
            </div>
            <div class="info-row">
                <span class="info-label">å……å€¼é‡‘é¢ï¼š</span>
                <span class="info-value amount-highlight" id="orderAmount">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">çŠ¶æ€ï¼š</span>
                <span class="status-badge" id="orderStatus">--</span>
            </div>
            <div class="info-row expire-time">
                <span class="info-label">è¿‡æœŸæ—¶é—´ï¼š</span>
                <span class="info-value" id="expireTime">--</span>
            </div>
        </div>

        <div class="qrcode-container">
            <div class="qrcode-wrapper">
                <img id="qrcodeImage" src="" alt="æ”¯ä»˜å®æ”¶æ¬¾ç " onerror="this.style.display='none'">
                <div class="qrcode-fallback" id="qrcodeFallback" style="display: none;">
                    <span class="fallback-icon">ğŸ“±</span>
                    <p>æ”¶æ¬¾ç åŠ è½½å¤±è´¥</p>
                    <p class="fallback-hint">è¯·è”ç³»ç®¡ç†å‘˜è·å–æ”¶æ¬¾ç </p>
                </div>
            </div>
            <div class="qrcode-instruction">
                <p><strong>æ”¯ä»˜æ­¥éª¤ï¼š</strong></p>
                <ol>
                    <li>æ‰“å¼€æ”¯ä»˜å®ï¼Œæ‰«æä¸Šæ–¹äºŒç»´ç </li>
                    <li>åœ¨ä»˜æ¬¾å¤‡æ³¨ä¸­è¾“å…¥è®¢å•å·ï¼š<code id="orderNoInCode">--</code></li>
                    <li>æ”¯ä»˜å®Œæˆåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç¡®è®¤ï¼ˆçº¦30ç§’ï¼‰</li>
                </ol>
            </div>
        </div>

        <div class="payment-actions">
            <button class="btn btn-secondary" onclick="RechargePage.checkPayment()">æ‰‹åŠ¨æ£€æŸ¥æ”¯ä»˜</button>
            <button class="btn btn-secondary" onclick="RechargePage.refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="settlement-preview" id="settlementPreview" style="display: none;">
            <h4>é¢„è®¡åˆ†è´¦æ˜ç»†</h4>
            <div id="settlementList"></div>
        </div>
    </div>
</div>

<!-- å……å€¼è®°å½• -->
<div class="records-section">
    <div class="section-header">
        <h3>å……å€¼è®°å½•</h3>
        <button class="btn btn-secondary" onclick="RechargePage.loadOrders()">
            <span class="icon">ğŸ”„</span> åˆ·æ–°
        </button>
    </div>

    <div class="data-card">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="50">ID</th>
                        <th width="140">è®¢å•å·</th>
                        <th width="100">é‡‘é¢</th>
                        <th width="100">çŠ¶æ€</th>
                        <th width="80">åˆ†è´¦</th>
                        <th width="160">åˆ›å»ºæ—¶é—´</th>
                        <th width="100">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr><td colspan="7" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.recharge-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
}

.recharge-form-card, .payment-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.recharge-form-card h3, .payment-card h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #1f2937;
    font-size: 18px;
}

.amount-presets {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.amount-preset {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.amount-preset:hover {
    border-color: #3b82f6;
    background: #eff6ff;
}

.amount-preset.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.amount-hint {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 10px 12px;
    background: #fef9c3;
    border-radius: 6px;
    font-size: 13px;
    color: #92400e;
}

.hint-icon {
    font-size: 16px;
}

.btn-large {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-top: 16px;
}

.current-balance {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
    margin-top: 16px;
}

.balance-label {
    color: #6b7280;
}

.balance-amount {
    font-size: 24px;
    font-weight: 600;
    color: #10b981;
}

/* æ”¯ä»˜ä¿¡æ¯å¡ç‰‡ */
.order-info {
    background: #f9fafb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
}

.info-row {
    display: flex;
    align-items: center;
    padding: 8px 0;
    gap: 8px;
}

.info-label {
    color: #6b7280;
    min-width: 80px;
}

.info-value {
    font-weight: 500;
    color: #1f2937;
}

.amount-highlight {
    color: #10b981;
    font-size: 18px;
    font-weight: 600;
}

.btn-copy {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    margin-left: auto;
}

.btn-copy:hover {
    background: #f3f4f6;
}

.expire-time {
    color: #ef4444;
    font-size: 13px;
}

/* äºŒç»´ç åŒºåŸŸ */
.qrcode-container {
    display: flex;
    gap: 24px;
    align-items: flex-start;
}

.qrcode-wrapper {
    flex-shrink: 0;
    width: 200px;
    height: 200px;
    background: #f9fafb;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qrcode-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 8px;
}

.qrcode-fallback {
    text-align: center;
    padding: 20px;
}

.fallback-icon {
    font-size: 40px;
}

.fallback-hint {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 8px;
}

.qrcode-instruction {
    flex: 1;
}

.qrcode-instruction p {
    margin-bottom: 8px;
}

.qrcode-instruction ol {
    padding-left: 20px;
    color: #6b7280;
}

.qrcode-instruction li {
    margin-bottom: 6px;
}

.qrcode-instruction code {
    background: #fef3c7;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    color: #92400e;
}

.payment-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

/* åˆ†è´¦é¢„è§ˆ */
.settlement-preview {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.settlement-preview h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #6b7280;
}

.settlement-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
}

.settlement-role {
    color: #6b7280;
}

.settlement-amount {
    font-weight: 500;
}

/* è®°å½•åŒºåŸŸ */
.records-section {
    margin-top: 32px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.section-header h3 {
    margin: 0;
}

/* è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† */
.modal-detail-row {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.modal-detail-row:last-child {
    border-bottom: none;
}

.modal-detail-label {
    width: 100px;
    color: #6b7280;
}

.modal-detail-value {
    flex: 1;
    font-weight: 500;
}

.transfer-item {
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 8px;
}

.transfer-item-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.transfer-role {
    font-weight: 500;
}

.transfer-status {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
}

.transfer-status.success {
    background: #dcfce7;
    color: #166534;
}

.transfer-status.failed {
    background: #fef2f2;
    color: #991b1b;
}

.transfer-status.pending {
    background: #fef3c7;
    color: #92400e;
}

.transfer-account {
    font-size: 13px;
    color: #6b7280;
}

.transfer-amount {
    font-weight: 600;
    color: #10b981;
}

@media (max-width: 768px) {
    .recharge-container {
        grid-template-columns: 1fr;
    }
    .qrcode-container {
        flex-direction: column;
    }
}
</style>

<!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="orderDetailModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>è®¢å•è¯¦æƒ…</h3>
            <button class="modal-close" onclick="RechargePage.closeDetailModal()">&times;</button>
        </div>
        <div class="modal-body" id="orderDetailContent">
            <!-- åŠ¨æ€å†…å®¹ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="RechargePage.closeDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
(function() {
    let currentOrderNo = null;
    let statusCheckInterval = null;

    const STATUS_MAP = {
        'pending': { label: 'å¾…æ”¯ä»˜', class: 'status-pending' },
        'paid': { label: 'å·²æ”¯ä»˜', class: 'status-success' },
        'confirmed': { label: 'å·²å®Œæˆ', class: 'status-success' },
        'cancelled': { label: 'å·²å–æ¶ˆ', class: 'status-disabled' },
        'expired': { label: 'å·²è¿‡æœŸ', class: 'status-disabled' }
    };

    // é¡µé¢åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        setTimeout(initPage, 0);
    }

    async function initPage() {
        await loadBalance();
        await loadOrders();
        setupAmountPresets();
        setupForm();
    }

    // åŠ è½½ä½™é¢
    async function loadBalance() {
        try {
            const data = await apiRequest('/recharge/wallet');
            document.getElementById('currentBalance').textContent = `Â¥${data.balance.toFixed(2)}`;
        } catch (error) {
            console.error('è·å–ä½™é¢å¤±è´¥:', error);
        }
    }

    // è®¾ç½®é‡‘é¢é¢„è®¾æŒ‰é’®
    function setupAmountPresets() {
        const presets = document.querySelectorAll('.amount-preset');
        const amountInput = document.getElementById('amount');

        presets.forEach(btn => {
            btn.addEventListener('click', () => {
                presets.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                amountInput.value = btn.dataset.amount;
            });
        });

        amountInput.addEventListener('input', () => {
            presets.forEach(b => b.classList.remove('active'));
        });
    }

    // è®¾ç½®è¡¨å•æäº¤
    function setupForm() {
        document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createOrder();
        });
    }

    // åˆ›å»ºè®¢å•
    async function createOrder() {
        const amount = parseFloat(document.getElementById('amount').value);
        const remarkIn = document.getElementById('remarkIn').value;

        if (!amount || amount <= 0) {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å……å€¼é‡‘é¢', 'error');
            return;
        }

        try {
            showToast('æ­£åœ¨åˆ›å»ºè®¢å•...', 'info');

            const data = await apiRequest('/recharge/orders', {
                method: 'POST',
                body: JSON.stringify({ amount, remark_in: remarkIn })
            });

            currentOrderNo = data.order_no;
            showPaymentCard(data);
            showToast('è®¢å•åˆ›å»ºæˆåŠŸï¼Œè¯·æ‰«ç æ”¯ä»˜', 'success');

            // å¼€å§‹è½®è¯¢çŠ¶æ€
            startStatusCheck();

        } catch (error) {
            showToast('åˆ›å»ºè®¢å•å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºæ”¯ä»˜å¡ç‰‡
    function showPaymentCard(order) {
        const card = document.getElementById('paymentCard');
        card.style.display = 'block';

        document.getElementById('orderNo').textContent = order.order_no;
        document.getElementById('orderNoInCode').textContent = order.order_no;
        document.getElementById('orderAmount').textContent = `Â¥${order.amount.toFixed(2)}`;
        updateOrderStatus(order.status, order);

        if (order.expired_at) {
            const expireTime = new Date(order.expired_at);
            document.getElementById('expireTime').textContent = formatDateTime(expireTime);
        }

        // æ˜¾ç¤ºäºŒç»´ç 
        const qrcodeImg = document.getElementById('qrcodeImage');
        const qrcodeFallback = document.getElementById('qrcodeFallback');

        if (order.qrcode_url) {
            qrcodeImg.src = order.qrcode_url;
            qrcodeImg.style.display = 'block';
            qrcodeFallback.style.display = 'none';
        } else {
            qrcodeImg.style.display = 'none';
            qrcodeFallback.style.display = 'block';
        }

        // æ»šåŠ¨åˆ°æ”¯ä»˜å¡ç‰‡
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // æ›´æ–°è®¢å•çŠ¶æ€
    function updateOrderStatus(status, order) {
        const statusEl = document.getElementById('orderStatus');
        const statusInfo = STATUS_MAP[status] || { label: status, class: '' };
        statusEl.textContent = statusInfo.label;
        statusEl.className = 'status-badge ' + statusInfo.class;

        // å¦‚æœå·²å®Œæˆï¼Œåœæ­¢è½®è¯¢
        if (status === 'confirmed' || status === 'cancelled' || status === 'expired') {
            stopStatusCheck();
            if (status === 'confirmed') {
                showToast('æ”¯ä»˜æˆåŠŸï¼åˆ†è´¦å·²å®Œæˆ', 'success');
                loadBalance();
            }
        }
    }

    // å¼€å§‹çŠ¶æ€æ£€æŸ¥
    function startStatusCheck() {
        stopStatusCheck();
        statusCheckInterval = setInterval(async () => {
            if (currentOrderNo) {
                await refreshStatus();
            }
        }, 15000); // æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡
    }

    // åœæ­¢çŠ¶æ€æ£€æŸ¥
    function stopStatusCheck() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }
    }

    // åˆ·æ–°çŠ¶æ€
    async function refreshStatus() {
        if (!currentOrderNo) return;

        try {
            const data = await apiRequest(`/recharge/orders/${currentOrderNo}`);
            updateOrderStatus(data.order.status, data.order);

            // æ›´æ–°è½¬è´¦è®°å½•æ˜¾ç¤º
            if (data.transfers && data.transfers.length > 0) {
                showSettlementPreview(data.transfers);
            }
        } catch (error) {
            console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // æ‰‹åŠ¨æ£€æŸ¥æ”¯ä»˜
    async function checkPayment() {
        if (!currentOrderNo) {
            showToast('æ²¡æœ‰å¾…æ£€æŸ¥çš„è®¢å•', 'warning');
            return;
        }

        try {
            showToast('æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...', 'info');
            const data = await apiRequest(`/recharge/orders/${currentOrderNo}/check`, {
                method: 'POST'
            });

            if (data.status === 'confirmed') {
                showToast('æ”¯ä»˜æˆåŠŸï¼', 'success');
            } else if (data.status === 'paid') {
                showToast('æ”¯ä»˜å·²ç¡®è®¤ï¼Œç­‰å¾…åˆ†è´¦å®Œæˆ', 'success');
            } else {
                showToast('å°šæœªæ£€æµ‹åˆ°æ”¯ä»˜ï¼Œè¯·ç¡®è®¤å·²å®Œæˆä»˜æ¬¾', 'warning');
            }

            await refreshStatus();
            await loadOrders();
            await loadBalance();
        } catch (error) {
            showToast('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºåˆ†è´¦é¢„è§ˆ
    function showSettlementPreview(transfers) {
        const container = document.getElementById('settlementPreview');
        const list = document.getElementById('settlementList');

        const roleMap = {
            'platform': 'å¹³å°',
            'agent_l1': 'ä¸€çº§ä»£ç†',
            'agent_l2': 'äºŒçº§ä»£ç†',
            'user': 'æˆ‘çš„æ”¶ç›Š'
        };

        list.innerHTML = transfers.map(t => `
            <div class="settlement-item">
                <span class="settlement-role">${roleMap[t.role] || t.role}</span>
                <span class="settlement-amount">Â¥${parseFloat(t.amount).toFixed(2)}</span>
            </div>
        `).join('');

        container.style.display = 'block';
    }

    // åŠ è½½è®¢å•åˆ—è¡¨
    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');

        try {
            const orders = await apiRequest('/recharge/orders');
            renderOrders(orders);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="7" class="error-cell">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
    }

    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');

        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">æš‚æ— å……å€¼è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = orders.map(order => {
            const statusInfo = STATUS_MAP[order.status] || { label: order.status, class: '' };
            const hasTransfers = order.status === 'confirmed' || order.status === 'paid';

            return `
                <tr>
                    <td>${order.id}</td>
                    <td><code style="font-size:12px;">${order.order_no}</code></td>
                    <td style="font-weight:600;color:#10b981;">Â¥${parseFloat(order.amount).toFixed(2)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></td>
                    <td>${hasTransfers ? '<span style="color:#10b981;">âœ“ å·²åˆ†è´¦</span>' : '-'}</td>
                    <td>${formatDateTime(order.created_at)}</td>
                    <td>
                        <button class="btn-action" onclick="RechargePage.viewDetail('${order.order_no}')">è¯¦æƒ…</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewDetail(orderNo) {
        try {
            const data = await apiRequest(`/recharge/orders/${orderNo}`);
            showOrderDetail(data);
        } catch (error) {
            showToast('è·å–è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
    function showOrderDetail(data) {
        const content = document.getElementById('orderDetailContent');
        const order = data.order;
        const transfers = data.transfers || [];

        const statusInfo = STATUS_MAP[order.status] || { label: order.status, class: '' };
        const roleMap = {
            'platform': 'å¹³å°',
            'agent_l1': 'ä¸€çº§ä»£ç†',
            'agent_l2': 'äºŒçº§ä»£ç†',
            'user': 'æˆ‘çš„æ”¶ç›Š'
        };

        let html = `
            <div class="modal-detail-row">
                <span class="modal-detail-label">è®¢å•å·</span>
                <span class="modal-detail-value"><code>${order.order_no}</code></span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">å……å€¼é‡‘é¢</span>
                <span class="modal-detail-value" style="color:#10b981;font-size:18px;">Â¥${parseFloat(order.amount).toFixed(2)}</span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">è®¢å•çŠ¶æ€</span>
                <span class="modal-detail-value"><span class="status-badge ${statusInfo.class}">${statusInfo.label}</span></span>
            </div>
            <div class="modal-detail-row">
                <span class="modal-detail-label">åˆ›å»ºæ—¶é—´</span>
                <span class="modal-detail-value">${formatDateTime(order.created_at)}</span>
            </div>
        `;

        if (order.paid_at) {
            html += `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¯ä»˜æ—¶é—´</span>
                    <span class="modal-detail-value">${formatDateTime(order.paid_at)}</span>
                </div>
            `;
        }

        if (order.alipay_trade_no) {
            html += `
                <div class="modal-detail-row">
                    <span class="modal-detail-label">æ”¯ä»˜å®äº¤æ˜“å·</span>
                    <span class="modal-detail-value"><code>${order.alipay_trade_no}</code></span>
                </div>
            `;
        }

        if (transfers.length > 0) {
            html += `<h4 style="margin:16px 0 8px;">åˆ†è´¦æ˜ç»†</h4>`;
            html += transfers.map(t => {
                const statusClass = t.status === 'success' ? 'success' : t.status === 'failed' ? 'failed' : 'pending';
                const statusLabel = t.status === 'success' ? 'æˆåŠŸ' : t.status === 'failed' ? 'å¤±è´¥' : 'å¾…å¤„ç†';

                return `
                    <div class="transfer-item">
                        <div class="transfer-item-header">
                            <span class="transfer-role">${roleMap[t.role] || t.role}</span>
                            <span class="transfer-status ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="transfer-account">${t.alipay_account || 'æœªè®¾ç½®è´¦å·'}</div>
                        <div class="transfer-amount">Â¥${parseFloat(t.amount).toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        content.innerHTML = html;
        document.getElementById('orderDetailModal').style.display = 'flex';
    }

    // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
    function closeDetailModal() {
        document.getElementById('orderDetailModal').style.display = 'none';
    }

    // å¤åˆ¶è®¢å•å·
    function copyOrderNo() {
        const orderNo = document.getElementById('orderNo').textContent;
        if (orderNo && orderNo !== '--') {
            navigator.clipboard.writeText(orderNo).then(() => {
                showToast('è®¢å•å·å·²å¤åˆ¶', 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return '-';
        }
    }

    // å¯¼å‡ºå…¨å±€API
    window.RechargePage = {
        checkPayment,
        refreshStatus,
        loadOrders,
        viewDetail,
        closeDetailModal,
        copyOrderNo
    };
})();
</script>
{% endblock %}
